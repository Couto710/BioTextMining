An improved automatic time-of-flight picker for medical ultrasound tomography Objective and motivation Time-of-flight (TOF) tomography used by a clinical ultrasound tomography device can efficiently and reliably produce sound–speed images of the breast for cancer diagnosis. Accurate picking of TOFs of transmitted ultrasound signals is extremely important to ensure high-resolution and high-quality ultrasound sound–speed tomograms. Since manually picking is time-consuming for large datasets, we developed an improved automatic TOF picker based on the Akaike information criterion (AIC), as described in this paper. Methods We make use of an approach termed multi-model inference (model averaging), based on the calculated AIC values, to improve the accuracy of TOF picks. By using multi-model inference, our picking method incorporates all the information near the TOF of ultrasound signals. Median filtering and reciprocal pair comparison are also incorporated in our AIC picker to effectively remove outliers. Results We validate our AIC picker using synthetic ultrasound waveforms, and demonstrate that our automatic TOF picker can accurately pick TOFs in the presence of random noise with absolute amplitudes up to 80% of the maximum absolute signal amplitude. We apply the new method to 1160 in vivo breast ultrasound waveforms, and compare the picked TOFs with manual picks and amplitude threshold picks. The mean value and standard deviation between our TOF picker and manual picking are 0.4 ?s and 0.29 ?s, while for amplitude threshold picker the values are 1.02 ?s and 0.9 ?s, respectively. Tomograms for in vivo breast data with high signal-to-noise ratio (SNR) (~25 dB) and low SNR (~18 dB) clearly demonstrate that our AIC picker is much less sensitive to the SNRs of the data, compared to the amplitude threshold picker. Discussion and conclusions The picking routine developed here is aimed at determining reliable quantitative values, necessary for adding diagnostic information to our clinical ultrasound tomography device – CURE. It has been successfully adopted into CURE, and allows us to generate such values reliably. We demonstrate that in vivo sound–speed tomograms with our TOF picks significantly improve the reconstruction accuracy and reduce image artifacts.  1. Introduction Ultrasound sound–speed tomography has great potential to detect and diagnose breast cancer ([ 1 – 4 ]). A clinical prototype of ultrasound breast-imaging system with a ring array, termed the computed ultrasound risk evaluation (CURE), has been developed at the Karmanos Cancer Institute, Wayne State University in Detroit, MI for ultrasound tomography [ 5 ] ( Fig. 1 ). In general, breast cancer has higher sound–speed than the surrounding breast tissue. A primary purpose of CURE is to efficiently and reliably produce sound–speed images of the breast for cancer detection and diagnosis. A potential sound–speed reconstruction method for such a purpose is time-of-flight (TOF) ultrasound transmission tomography. Accurate picking of TOFs of ultrasound transmitted signals is an extremely important step to ensure high-resolution and high-quality reconstruction of the sound–speed distribution. For each 2D slice of ultrasound breast data, each element of the CURE device acts as a transmitter as well as a receiver, and all elements receive the scattered sound waves when one element transmits. CURE acquires 70–80 slices of ultrasound data for whole breast imaging, resulting in a large volume of ultrasound data for each patient. Therefore, it is not feasible to manually pick TOFs of transmitted ultrasound data for sound–speed tomography because manual picking is too time-consuming (~600,000 waveforms needs to be analyzed for each patient). An automatic TOF picker is an important tool for ultrasound tomography, particularly for clinical applications. Different automatic TOF pickers have been developed, and most of them have been used for geophysical applications to reconstruct the internal structure of the earth. These techniques fall into three general categories. The simplest method is the amplitude threshold picker that applies an absolute value of the threshold to the band-pass filtered signal. It is not applicable for data having low signal-to-noise ratios (SNRs). A variation is called “short-term-average/long-term-average (STA/LTA)” method using the signal's envelope [ 6 ]. The second type of auto-pickers utilizes a running window. Certain characteristics are repeatedly calculated within successive sections of the time series, producing a time dependent function. The TOF is usually identified by an obvious change in the behavior of this function ([ 7 , 8 ]). The third type of auto-picker relies on using the coherence characteristic between traces. One among these pickers convolves a shifting reference waveform with the signal. The TOF of the signal is determined when the measure of the quality of the match is a maximum. This method assumes that the signal is reasonably similar to the reference waveform. Several papers describe this type of picker, including [ 9 – 11 ]. In 1951 Kullback and Leibler [ 12 ] proposed what is now known as the Kullback–Leibler information criterion to measure the information loss when approximating reality using recorded data. In 1970s, Akaike (cited in [ 13 ]) proposed a model selection criterion, the Akaike information criterion (AIC), which relates the maximum likelihood with the Kullback–Leibler information criterion and minimizes the information loss during model selection. Sleeman and Eck [ 14 ] applied the AIC and autoregressive (AR) techniques to detect the TOFs of seismograms, and their TOF picker is called AR–AIC picker. Autoregressive techniques are based on the assumption that a waveform can be divided into locally stationary segments as an AR process and the segments before and after the TOF point are two different stationary processes. On the basis of this assumption, the AR–AIC picker can be used to detect the TOF of a seismogram by analyzing the variation in AR coefficients. The AIC is usually used to determine the order of the AR process when fitting a time series. When the order of the AR process is fixed, the AIC is a measure of the model fit. In the AR–AIC picker, the order of the AR coefficient is determined on a trial and error basis (for details see [ 14 ]). To overcome this difficulty and inefficiency, Zhang et al. [ 8 ] proposed a wavelet–AIC picker in which the AIC values are calculated directly from the seismogram using Maeda's formula [ 15 ]. In this method, a running window and a wavelet transform are used to guide the AIC picker by finding the appropriate time window that includes the TOF point of a seismogram. All the above techniques were historically developed to pick elastic signals, particularly seismic waves. To the best of our knowledge, no one has developed and investigated an automatic TOF picker for in vivo medical ultrasound data. Kurz et al. [ 16 ] is one of the few who applied an auto-picker to acoustic emission in concrete. In this paper, we develop an improved AIC automatic TOF picker and apply it to in vivo ultrasound breast data based on the wavelet–AIC TOF picker described in [ 8 ]. The improved method makes use of an approach termed multi-model inference (model averaging), based on the calculated AIC values, to enhance the accuracy of TOF picks. We investigate the application of a median filter to remove TOF outliers. We demonstrate that our improved automatic TOF picker can accurately pick TOFs in the presence of random noise of up to 80% of the maximum absolute synthetic signal amplitude. We apply the improved automatic TOF picking method to clinical ultrasound breast data, and demonstrate that ultrasound sound–speed tomography with our improved automatic TOF picks significantly enhances the reconstruction accuracy and reduces image artifacts.  2. Materials and methods 2.1. Ultrasound breast data acquired using the CURE device Clinical ultrasound breast data used for this study were collected with the CURE device, a clinical prototype ultrasound scanner designed for clinical ultrasound breast tomography. CURE is capable of recording all ultrasound wavefields including reflected, transmitted, and diffracted ultrasonic signals from the breast tissue. The engineering prototype of CURE is described in [ 17 ], and the current clinical prototype is described in [ 5 ]. Fig. 1a is a schematic representation of the transducer ring. Fig. 1b illustrates scattering of ultrasound emitted from a transducer element and received by all transducer elements along the ring. There are a total of 256 elements in the 20-cm diameter ring array. Each element can emit and receive ultrasound waves with a central frequency of 1.5 MHz. During the scan, the ring array is immersed in a water tank, and encircles the breast. The signals are recorded at a sampling rate of 6.25 MHz. The whole breast is scanned slice by slice, and the scanned slice data are recorded by a computer for data processing afterwards. A motorized gantry is used to translate the ring along the vertical direction, starting from the chest wall to the nipple. 2.2. Improved automatic AIC time-of-flight picker The wavelet–AIC TOF picker [ 8 ] is based on the AR–AIC picker which assumes that a signal can be divided into locally stationary segments and that the segments before and after the time-of-flight point are two different stationary processes ([ 14 ]). Data points within the selected time window are divided into two segments at each data point i ( i = 1; ...; k ; ...; N ; where N is the total number of data points in the selected time window). For a given data point k the wavelet–AIC TOF picker uses Maeda's formula ([ 15 ]) to calculate the AIC function directly from the waveform (1) AIC ( k ) = k log ( var ( S ( 1 , k ) ) ) + ( N ? k ? 1 ) log ( var ( S ( k + 1 , N ) ) ) , where S (1, k ) (for data points 1 through k ) and S ( k + 1, N ) (for data points k + 1 through N ) are the two segments in the selected time window, and the variance function “var(·)” is calculated using (2) var ( S ( i , j ) ) = ? j ? 1 2 = 1 j ? i ? l = i j ( S ( l , l ) ? S ? ) 2 , i ? j , i = 1 , … , N and j = 1 , … , N , where S? is the mean value of S ( i,j ) The AIC value given by Eq. (1) measures the information loss of using the current selected model to approximate reality. In the wavelet–AIC auto-picker in [ 8 ], the point with minimum AIC value (that indicates the minimum information loss, therefore it is called the best model) is selected to be the TOF point. We improve the automatic wavelet–AIC TOF picker by: (1) using a weighted average model instead of the best model to determine TOFs; (2) removing outliers of TOF picks using a median filter; and (3) eliminating effects of signal distortion due to filtering and wavelet de-noising during data preprocessing for improving SNR. A schematic flowchart of our improved AIC TOF picker is shown in Fig. 2 . We describe the details of our improvements as follows. 2.2.1. Using a weighted average model to determine TOFs An AIC value by itself has no physical meaning and it becomes interesting only when it is compared to a series of a priori specified models [ 18 ]. The model with the minimum AIC value is the best among all models being compared. The measure associated with the AIC value that can be used to compare models is the normalized Akaike weights ( Eq. (3) and (4) ). Akaike weights indicate the relative importance of the candidate models. In most cases, the best model (corresponding to the minimum AIC value) may have competitors for the top rank. An elegant solution to make an inference based on the entire set of models is to compute the weighted average based on the model uncertainties (i.e. Akaike weights). This is referred to model averaging or model inference. The running window used in for the wavelet–AIC TOF picker [ 8 ] is not necessary for clinical ultrasound data. An appropriate time window used for the TOF pick can be well defined based on the transmitter–receiver geometry and the sound–speed of water since the sound–speed of breast tissue is close to that of water. To incorporate all the information near the best model, we use a weighted average model to pick the TOF in the following sequence: Calculate AIC values (AIC i, i = 1,... n ) for a series of data points near the point with the minimum AIC (AICmin) using Eq. (1) . Obtain the differences between AIC i ( i = 1,... n ) and AICmin: (3) ? i = AIC i ? AIC min , Compute the Akaike weights for each data point within the time window: (4) W i = exp ( ? ? i ? 2 ) ? r = 1 n exp ( ? ? r ? 2 ) Obtain the TOF value using the weighted average: (5) t TOF = ? i = 1 n w i t i , where t i ( i = 1; . . . ; n ) are the corresponding travel times for those points discussed in (1) – (3) and w i is obtained using Eq. (4) . When there is a sharp global minimum, the AIC value that indicates a high SNR, the difference between the TOF pick based on the weighted average model and that based on the best model is negligible. However, if the global minimum is not very sharp, which indicates a low SNR, the weighted average model can pick the TOF more accurately than picking based on the best model. This is the primary advantage of the automatic TOF picking method based on the weighted model averaging scheme. Fig. 3 shows an example of comparison among the TOF pick based on the best model, the TOF pick based on the weighted average model, and the manual pick of an in vivo ultrasound breast signal acquired using the CURE device. The circle represents the TOF picked with the best model, the star corresponds to the manual pick of the TOF, and the cross sign is the TOF pick using the weighted average model. It can be seen that the latter is closer to the manual TOF pick than the pick based on the best model. 2.2.2. Removing outliers of TOF picks To eliminate outliers of the TOF picks, we apply a median filter to the time differences (TDs) between our picked TOFs of ultra-sound breast data and TOFs calculated using the water sound–speed and the ring array geometry. The median filter is a good tool for reducing “pepper and salt” noise (outliers). To take advantage of this property and the continuity property of a TOF surface (formed by TOFs of all transmission data) ([ 19 ]), TDs are rearranged into a 2-D matrix such that each row represents the TD values for a single transmitter, and TD values for adjacent transmitters in the ring array are put into adjacent rows (except the first and last transmitter due to the circular geometry of the ring). This rearrangement results in a 256 by 256 matrix ( D ). Another 256 by 256 matrix ( M ) containing all median values of TOFs is calculated with a sliding window of the same size as the median filter. Adaptive thresholds for the median filter are set up by calculating the standard deviation (STD) and the mean value (ME) of TDs (6) TolMin = ME ? f ? STD , TolMax = ME + f ? STD . where TolMin and TolMax are the minimum (could be a negative value) and maximum tolerance for TDs, respectively, and f is a given scale factor of the standard deviations with a value between 0 and 1. The median filter based on the above thresholds is applied to the matrix D : if D ( i,j ) – M ( i,j ) < TolMin or D ( i,j ) – M ( i,j ) > TolMax and the corresponding picked TOF is replaced with the medium value. To further clean up the remaining picks, the TOF picks for the reciprocal transmitter–receiver pair are compared against each other. Reciprocal transmitter–receiver pair, here, means that two transducers in the ring array transmit and receiver signals in the opposite directions. Ideally, the TOF picks for the reciprocal pair should be the same, which rarely happens in practice. In our data cleaning process, if the TOFs difference between the reciprocal pair exceeds a predefined threshold, both picks are discarded. The predefined threshold value can be customized by users based on their individual requirement and data quality. The original matrix D and its post-processed version for an in vivo ultrasound breast data acquired using the CURE device are shown in Figs. 4a and b , respectively. Compared with Fig. 4a , Fig. 4b shows that the inconsistent picks and outliers are effectively eliminated. Figs. 4c and d are ultrasound sound–speed transmission tomography results for an in vivo ultrasound breast dataset using the TOF picks shown in Figs. 4a and b , respectively. Fig. 4 demonstrates that our TOF data cleaning procedure described above can effectively remove TOF outliers and greatly improve the quality of ultrasound TOF sound–speed tomography images. 2.2.3. Signal distortion due to filtering and wavelet de-noising Filtering and de-noising techniques are usually used to preprocess a signal to improve its SNRs. The wavelet–AIC TOF picker [ 8 ] applies the wavelet de-noising to a raw seismogram before it picks the TOF. In fact, both the filtering and wavelet de-noising may distort a signal while attempting to increase the SNR [ 20 ]. Fig. 5 shows a comparison of a raw ultrasound data segment ( Fig. 5a ) acquired with the CURE device with its filtered version ( Fig. 5b ) and wavelet de-noised version ( Fig. 5c ). The signal in Fig. 5b was filtered using a second-order zero-phase Butterworth band-pass filter with the stop band corner frequencies at 0.3 MHz and 2.3 MHz, and the pass band corner frequencies at 0.9 MHz and 1.7 MHz. For the wavelet de-noised signal in Fig. 5c , thresholding was applied to the wavelet coefficients using the Birge–Massart penalization method [ 21 ]. The solid vertical line in Fig. 5 represents the picked TOFs from the raw ultrasound data, while the dashed line indicates the picked TOFs from the filtered and de-noised segments. Coincidently, TOFs picked from the band-pass filtered signal and the wavelet de-noised signal are the same ( Table 1 ). From Fig. 5 we can see the signal distortions due to the wavelet de-noising and zero-phase band-pass filtering. Because of the short transient time of ultrasound signals, a small distortion of the ultrasound waveform may result in large unwanted artifacts or erroneous information during TOF picking. For these reasons and in order to preserve the true shapes of onsets of ultrasound signals as much as possible, we do not perform any signal preprocessing to improve the SNRs, because our improved automatic TOF picker can handle ultrasound data with low SNRs as demonstrated in the following. 2.2.4. Capability to handle noisy data To estimate the maximum amount of random noise that our improved wavelet–AIC TOF picker can tolerate, progressively greater amounts of random noise were added to a synthetic ultrasound waveform with a similar spectrum to that of in vivo ultrasound breast data acquired by CURE. The average absolute amplitudes of the random noise were, respectively, 0%, 20%, 40%, 60% and 80% of the maximum absolute amplitude of the synthetic ultrasound signal. Our improved TOF picker can detect consistently the correct TOF in the presence of 80% white noise, which corresponds to a 4.5 dB SNR. Fig. 6 shows two representative examples with 0% and 80% random noise added, respectively. Both our own tests and Kurz's work in [ 16 ] show that the AIC-based TOF pickers can tolerate a relatively high noise level if an appropriate time window is used. 2.3. Assessment of our improved AIC time-of-flight picker To assess the performance of our improved AIC picker, we compared our TOF picks with those of the amplitude threshold picker, and manual picks of 1160 waveforms of in vivo ultrasound breast waveforms acquired using the CURE device. Manual picking was conducted by recognizing the first rise time of the signal. To exploit the continuity of picked TOFs for adjacent waveforms [ 19 ], five consecutive waveforms were plotted on the computer monitor at the same time to further improve the accuracy of the manual picking. Fig. 7 is a snapshot of the manual picking process, in which solid triangles indicate the manual TOF picks by clicking the computer mouse. Since the amplitude threshold picker is much more sensitive to the noise in the data, band-pass filtering was applied before picking the TOFs using an amplitude threshold. A second order zero-phase Butterworth band-pass filter with stop band corner frequencies at 0.3 MHz and 2.3 MHz, and pass band corner frequencies at 0.9 MHz and 1.7 MHz was used to filter the ultrasound breast data. To make a fair comparison, the same outlier removal procedures (median filtering and reciprocal pair check) were also applied to the amplitude threshold TOF picks. Fig. 8a shows the absolute values of TOF differences between manual picks and amplitude threshold picks, and Fig. 8b shows those of TOF difference between manual picks and our improved AIC picks. The statistics ( Table 2 ) shows that for these 1160 in vivo ultrasound breast waveforms, over 85% of the TOFs picked by our improved AIC picker are within three sample points (0.48 ?s) from the manual picks. The mean value and standard deviation between our improved TOF picker and manual picking are 0.4 ?s and 0.29 ?s, respectively. Among picks by the amplitude threshold picker, only 48% of them are within the three sample points from the manual picks, and the mean value and standard deviation from the manual picks are respectively 1.02 ?s and 0.9 ?s, which are much higher than those of our improved TOF picking method. Our study with other clinical ultrasound breast data shows that the performances of our improved wavelet–AIC TOF picker and amplitude threshold-based TOF picker are comparable for data with high SNRs, but for data with high noise level (or low SNRs), the accuracy of the amplitude threshold picker drops abruptly. Moreover, for noisy ultrasound breast data, the failure rate of the amplitude threshold TOF picker is much higher than for that of the improved AIC TOF picker. Fig. 9 shows two waveforms of different SNRs along with TOF picks by the above three methods. We can clearly see that for the waveform in Fig. 9a , which has a high SNR, the three TOF picks are consistent, although our improved AIC pick is closer to the manual pick. However, for a noisy waveform in Fig. 9b , the amplitude threshold picker picked the wrong TOF, while our improved AIC TOF pick is still comparable to the manual pick. The TOF picks in Fig. 9 are shown in Table 3 . An example of overlays of the TOF picks by our improved AIC TOF picker on the corresponding in vivo ultrasonic breast waveforms is depicted in Fig. 10 (the solid dot on each waveform segment indicates our TOF pick).  2.1. Ultrasound breast data acquired using the CURE device Clinical ultrasound breast data used for this study were collected with the CURE device, a clinical prototype ultrasound scanner designed for clinical ultrasound breast tomography. CURE is capable of recording all ultrasound wavefields including reflected, transmitted, and diffracted ultrasonic signals from the breast tissue. The engineering prototype of CURE is described in [ 17 ], and the current clinical prototype is described in [ 5 ]. Fig. 1a is a schematic representation of the transducer ring. Fig. 1b illustrates scattering of ultrasound emitted from a transducer element and received by all transducer elements along the ring. There are a total of 256 elements in the 20-cm diameter ring array. Each element can emit and receive ultrasound waves with a central frequency of 1.5 MHz. During the scan, the ring array is immersed in a water tank, and encircles the breast. The signals are recorded at a sampling rate of 6.25 MHz. The whole breast is scanned slice by slice, and the scanned slice data are recorded by a computer for data processing afterwards. A motorized gantry is used to translate the ring along the vertical direction, starting from the chest wall to the nipple.  2.2. Improved automatic AIC time-of-flight picker The wavelet–AIC TOF picker [ 8 ] is based on the AR–AIC picker which assumes that a signal can be divided into locally stationary segments and that the segments before and after the time-of-flight point are two different stationary processes ([ 14 ]). Data points within the selected time window are divided into two segments at each data point i ( i = 1; ...; k ; ...; N ; where N is the total number of data points in the selected time window). For a given data point k the wavelet–AIC TOF picker uses Maeda's formula ([ 15 ]) to calculate the AIC function directly from the waveform (1) AIC ( k ) = k log ( var ( S ( 1 , k ) ) ) + ( N ? k ? 1 ) log ( var ( S ( k + 1 , N ) ) ) , where S (1, k ) (for data points 1 through k ) and S ( k + 1, N ) (for data points k + 1 through N ) are the two segments in the selected time window, and the variance function “var(·)” is calculated using (2) var ( S ( i , j ) ) = ? j ? 1 2 = 1 j ? i ? l = i j ( S ( l , l ) ? S ? ) 2 , i ? j , i = 1 , … , N and j = 1 , … , N , where S? is the mean value of S ( i,j ) The AIC value given by Eq. (1) measures the information loss of using the current selected model to approximate reality. In the wavelet–AIC auto-picker in [ 8 ], the point with minimum AIC value (that indicates the minimum information loss, therefore it is called the best model) is selected to be the TOF point. We improve the automatic wavelet–AIC TOF picker by: (1) using a weighted average model instead of the best model to determine TOFs; (2) removing outliers of TOF picks using a median filter; and (3) eliminating effects of signal distortion due to filtering and wavelet de-noising during data preprocessing for improving SNR. A schematic flowchart of our improved AIC TOF picker is shown in Fig. 2 . We describe the details of our improvements as follows. 2.2.1. Using a weighted average model to determine TOFs An AIC value by itself has no physical meaning and it becomes interesting only when it is compared to a series of a priori specified models [ 18 ]. The model with the minimum AIC value is the best among all models being compared. The measure associated with the AIC value that can be used to compare models is the normalized Akaike weights ( Eq. (3) and (4) ). Akaike weights indicate the relative importance of the candidate models. In most cases, the best model (corresponding to the minimum AIC value) may have competitors for the top rank. An elegant solution to make an inference based on the entire set of models is to compute the weighted average based on the model uncertainties (i.e. Akaike weights). This is referred to model averaging or model inference. The running window used in for the wavelet–AIC TOF picker [ 8 ] is not necessary for clinical ultrasound data. An appropriate time window used for the TOF pick can be well defined based on the transmitter–receiver geometry and the sound–speed of water since the sound–speed of breast tissue is close to that of water. To incorporate all the information near the best model, we use a weighted average model to pick the TOF in the following sequence: Calculate AIC values (AIC i, i = 1,... n ) for a series of data points near the point with the minimum AIC (AICmin) using Eq. (1) . Obtain the differences between AIC i ( i = 1,... n ) and AICmin: (3) ? i = AIC i ? AIC min , Compute the Akaike weights for each data point within the time window: (4) W i = exp ( ? ? i ? 2 ) ? r = 1 n exp ( ? ? r ? 2 ) Obtain the TOF value using the weighted average: (5) t TOF = ? i = 1 n w i t i , where t i ( i = 1; . . . ; n ) are the corresponding travel times for those points discussed in (1) – (3) and w i is obtained using Eq. (4) . When there is a sharp global minimum, the AIC value that indicates a high SNR, the difference between the TOF pick based on the weighted average model and that based on the best model is negligible. However, if the global minimum is not very sharp, which indicates a low SNR, the weighted average model can pick the TOF more accurately than picking based on the best model. This is the primary advantage of the automatic TOF picking method based on the weighted model averaging scheme. Fig. 3 shows an example of comparison among the TOF pick based on the best model, the TOF pick based on the weighted average model, and the manual pick of an in vivo ultrasound breast signal acquired using the CURE device. The circle represents the TOF picked with the best model, the star corresponds to the manual pick of the TOF, and the cross sign is the TOF pick using the weighted average model. It can be seen that the latter is closer to the manual TOF pick than the pick based on the best model. 2.2.2. Removing outliers of TOF picks To eliminate outliers of the TOF picks, we apply a median filter to the time differences (TDs) between our picked TOFs of ultra-sound breast data and TOFs calculated using the water sound–speed and the ring array geometry. The median filter is a good tool for reducing “pepper and salt” noise (outliers). To take advantage of this property and the continuity property of a TOF surface (formed by TOFs of all transmission data) ([ 19 ]), TDs are rearranged into a 2-D matrix such that each row represents the TD values for a single transmitter, and TD values for adjacent transmitters in the ring array are put into adjacent rows (except the first and last transmitter due to the circular geometry of the ring). This rearrangement results in a 256 by 256 matrix ( D ). Another 256 by 256 matrix ( M ) containing all median values of TOFs is calculated with a sliding window of the same size as the median filter. Adaptive thresholds for the median filter are set up by calculating the standard deviation (STD) and the mean value (ME) of TDs (6) TolMin = ME ? f ? STD , TolMax = ME + f ? STD . where TolMin and TolMax are the minimum (could be a negative value) and maximum tolerance for TDs, respectively, and f is a given scale factor of the standard deviations with a value between 0 and 1. The median filter based on the above thresholds is applied to the matrix D : if D ( i,j ) – M ( i,j ) < TolMin or D ( i,j ) – M ( i,j ) > TolMax and the corresponding picked TOF is replaced with the medium value. To further clean up the remaining picks, the TOF picks for the reciprocal transmitter–receiver pair are compared against each other. Reciprocal transmitter–receiver pair, here, means that two transducers in the ring array transmit and receiver signals in the opposite directions. Ideally, the TOF picks for the reciprocal pair should be the same, which rarely happens in practice. In our data cleaning process, if the TOFs difference between the reciprocal pair exceeds a predefined threshold, both picks are discarded. The predefined threshold value can be customized by users based on their individual requirement and data quality. The original matrix D and its post-processed version for an in vivo ultrasound breast data acquired using the CURE device are shown in Figs. 4a and b , respectively. Compared with Fig. 4a , Fig. 4b shows that the inconsistent picks and outliers are effectively eliminated. Figs. 4c and d are ultrasound sound–speed transmission tomography results for an in vivo ultrasound breast dataset using the TOF picks shown in Figs. 4a and b , respectively. Fig. 4 demonstrates that our TOF data cleaning procedure described above can effectively remove TOF outliers and greatly improve the quality of ultrasound TOF sound–speed tomography images. 2.2.3. Signal distortion due to filtering and wavelet de-noising Filtering and de-noising techniques are usually used to preprocess a signal to improve its SNRs. The wavelet–AIC TOF picker [ 8 ] applies the wavelet de-noising to a raw seismogram before it picks the TOF. In fact, both the filtering and wavelet de-noising may distort a signal while attempting to increase the SNR [ 20 ]. Fig. 5 shows a comparison of a raw ultrasound data segment ( Fig. 5a ) acquired with the CURE device with its filtered version ( Fig. 5b ) and wavelet de-noised version ( Fig. 5c ). The signal in Fig. 5b was filtered using a second-order zero-phase Butterworth band-pass filter with the stop band corner frequencies at 0.3 MHz and 2.3 MHz, and the pass band corner frequencies at 0.9 MHz and 1.7 MHz. For the wavelet de-noised signal in Fig. 5c , thresholding was applied to the wavelet coefficients using the Birge–Massart penalization method [ 21 ]. The solid vertical line in Fig. 5 represents the picked TOFs from the raw ultrasound data, while the dashed line indicates the picked TOFs from the filtered and de-noised segments. Coincidently, TOFs picked from the band-pass filtered signal and the wavelet de-noised signal are the same ( Table 1 ). From Fig. 5 we can see the signal distortions due to the wavelet de-noising and zero-phase band-pass filtering. Because of the short transient time of ultrasound signals, a small distortion of the ultrasound waveform may result in large unwanted artifacts or erroneous information during TOF picking. For these reasons and in order to preserve the true shapes of onsets of ultrasound signals as much as possible, we do not perform any signal preprocessing to improve the SNRs, because our improved automatic TOF picker can handle ultrasound data with low SNRs as demonstrated in the following. 2.2.4. Capability to handle noisy data To estimate the maximum amount of random noise that our improved wavelet–AIC TOF picker can tolerate, progressively greater amounts of random noise were added to a synthetic ultrasound waveform with a similar spectrum to that of in vivo ultrasound breast data acquired by CURE. The average absolute amplitudes of the random noise were, respectively, 0%, 20%, 40%, 60% and 80% of the maximum absolute amplitude of the synthetic ultrasound signal. Our improved TOF picker can detect consistently the correct TOF in the presence of 80% white noise, which corresponds to a 4.5 dB SNR. Fig. 6 shows two representative examples with 0% and 80% random noise added, respectively. Both our own tests and Kurz's work in [ 16 ] show that the AIC-based TOF pickers can tolerate a relatively high noise level if an appropriate time window is used.  2.2.1. Using a weighted average model to determine TOFs An AIC value by itself has no physical meaning and it becomes interesting only when it is compared to a series of a priori specified models [ 18 ]. The model with the minimum AIC value is the best among all models being compared. The measure associated with the AIC value that can be used to compare models is the normalized Akaike weights ( Eq. (3) and (4) ). Akaike weights indicate the relative importance of the candidate models. In most cases, the best model (corresponding to the minimum AIC value) may have competitors for the top rank. An elegant solution to make an inference based on the entire set of models is to compute the weighted average based on the model uncertainties (i.e. Akaike weights). This is referred to model averaging or model inference. The running window used in for the wavelet–AIC TOF picker [ 8 ] is not necessary for clinical ultrasound data. An appropriate time window used for the TOF pick can be well defined based on the transmitter–receiver geometry and the sound–speed of water since the sound–speed of breast tissue is close to that of water. To incorporate all the information near the best model, we use a weighted average model to pick the TOF in the following sequence: Calculate AIC values (AIC i, i = 1,... n ) for a series of data points near the point with the minimum AIC (AICmin) using Eq. (1) . Obtain the differences between AIC i ( i = 1,... n ) and AICmin: (3) ? i = AIC i ? AIC min , Compute the Akaike weights for each data point within the time window: (4) W i = exp ( ? ? i ? 2 ) ? r = 1 n exp ( ? ? r ? 2 ) Obtain the TOF value using the weighted average: (5) t TOF = ? i = 1 n w i t i , where t i ( i = 1; . . . ; n ) are the corresponding travel times for those points discussed in (1) – (3) and w i is obtained using Eq. (4) . When there is a sharp global minimum, the AIC value that indicates a high SNR, the difference between the TOF pick based on the weighted average model and that based on the best model is negligible. However, if the global minimum is not very sharp, which indicates a low SNR, the weighted average model can pick the TOF more accurately than picking based on the best model. This is the primary advantage of the automatic TOF picking method based on the weighted model averaging scheme. Fig. 3 shows an example of comparison among the TOF pick based on the best model, the TOF pick based on the weighted average model, and the manual pick of an in vivo ultrasound breast signal acquired using the CURE device. The circle represents the TOF picked with the best model, the star corresponds to the manual pick of the TOF, and the cross sign is the TOF pick using the weighted average model. It can be seen that the latter is closer to the manual TOF pick than the pick based on the best model.  2.2.2. Removing outliers of TOF picks To eliminate outliers of the TOF picks, we apply a median filter to the time differences (TDs) between our picked TOFs of ultra-sound breast data and TOFs calculated using the water sound–speed and the ring array geometry. The median filter is a good tool for reducing “pepper and salt” noise (outliers). To take advantage of this property and the continuity property of a TOF surface (formed by TOFs of all transmission data) ([ 19 ]), TDs are rearranged into a 2-D matrix such that each row represents the TD values for a single transmitter, and TD values for adjacent transmitters in the ring array are put into adjacent rows (except the first and last transmitter due to the circular geometry of the ring). This rearrangement results in a 256 by 256 matrix ( D ). Another 256 by 256 matrix ( M ) containing all median values of TOFs is calculated with a sliding window of the same size as the median filter. Adaptive thresholds for the median filter are set up by calculating the standard deviation (STD) and the mean value (ME) of TDs (6) TolMin = ME ? f ? STD , TolMax = ME + f ? STD . where TolMin and TolMax are the minimum (could be a negative value) and maximum tolerance for TDs, respectively, and f is a given scale factor of the standard deviations with a value between 0 and 1. The median filter based on the above thresholds is applied to the matrix D : if D ( i,j ) – M ( i,j ) < TolMin or D ( i,j ) – M ( i,j ) > TolMax and the corresponding picked TOF is replaced with the medium value. To further clean up the remaining picks, the TOF picks for the reciprocal transmitter–receiver pair are compared against each other. Reciprocal transmitter–receiver pair, here, means that two transducers in the ring array transmit and receiver signals in the opposite directions. Ideally, the TOF picks for the reciprocal pair should be the same, which rarely happens in practice. In our data cleaning process, if the TOFs difference between the reciprocal pair exceeds a predefined threshold, both picks are discarded. The predefined threshold value can be customized by users based on their individual requirement and data quality. The original matrix D and its post-processed version for an in vivo ultrasound breast data acquired using the CURE device are shown in Figs. 4a and b , respectively. Compared with Fig. 4a , Fig. 4b shows that the inconsistent picks and outliers are effectively eliminated. Figs. 4c and d are ultrasound sound–speed transmission tomography results for an in vivo ultrasound breast dataset using the TOF picks shown in Figs. 4a and b , respectively. Fig. 4 demonstrates that our TOF data cleaning procedure described above can effectively remove TOF outliers and greatly improve the quality of ultrasound TOF sound–speed tomography images.  2.2.3. Signal distortion due to filtering and wavelet de-noising Filtering and de-noising techniques are usually used to preprocess a signal to improve its SNRs. The wavelet–AIC TOF picker [ 8 ] applies the wavelet de-noising to a raw seismogram before it picks the TOF. In fact, both the filtering and wavelet de-noising may distort a signal while attempting to increase the SNR [ 20 ]. Fig. 5 shows a comparison of a raw ultrasound data segment ( Fig. 5a ) acquired with the CURE device with its filtered version ( Fig. 5b ) and wavelet de-noised version ( Fig. 5c ). The signal in Fig. 5b was filtered using a second-order zero-phase Butterworth band-pass filter with the stop band corner frequencies at 0.3 MHz and 2.3 MHz, and the pass band corner frequencies at 0.9 MHz and 1.7 MHz. For the wavelet de-noised signal in Fig. 5c , thresholding was applied to the wavelet coefficients using the Birge–Massart penalization method [ 21 ]. The solid vertical line in Fig. 5 represents the picked TOFs from the raw ultrasound data, while the dashed line indicates the picked TOFs from the filtered and de-noised segments. Coincidently, TOFs picked from the band-pass filtered signal and the wavelet de-noised signal are the same ( Table 1 ). From Fig. 5 we can see the signal distortions due to the wavelet de-noising and zero-phase band-pass filtering. Because of the short transient time of ultrasound signals, a small distortion of the ultrasound waveform may result in large unwanted artifacts or erroneous information during TOF picking. For these reasons and in order to preserve the true shapes of onsets of ultrasound signals as much as possible, we do not perform any signal preprocessing to improve the SNRs, because our improved automatic TOF picker can handle ultrasound data with low SNRs as demonstrated in the following.  2.2.4. Capability to handle noisy data To estimate the maximum amount of random noise that our improved wavelet–AIC TOF picker can tolerate, progressively greater amounts of random noise were added to a synthetic ultrasound waveform with a similar spectrum to that of in vivo ultrasound breast data acquired by CURE. The average absolute amplitudes of the random noise were, respectively, 0%, 20%, 40%, 60% and 80% of the maximum absolute amplitude of the synthetic ultrasound signal. Our improved TOF picker can detect consistently the correct TOF in the presence of 80% white noise, which corresponds to a 4.5 dB SNR. Fig. 6 shows two representative examples with 0% and 80% random noise added, respectively. Both our own tests and Kurz's work in [ 16 ] show that the AIC-based TOF pickers can tolerate a relatively high noise level if an appropriate time window is used.  2.3. Assessment of our improved AIC time-of-flight picker To assess the performance of our improved AIC picker, we compared our TOF picks with those of the amplitude threshold picker, and manual picks of 1160 waveforms of in vivo ultrasound breast waveforms acquired using the CURE device. Manual picking was conducted by recognizing the first rise time of the signal. To exploit the continuity of picked TOFs for adjacent waveforms [ 19 ], five consecutive waveforms were plotted on the computer monitor at the same time to further improve the accuracy of the manual picking. Fig. 7 is a snapshot of the manual picking process, in which solid triangles indicate the manual TOF picks by clicking the computer mouse. Since the amplitude threshold picker is much more sensitive to the noise in the data, band-pass filtering was applied before picking the TOFs using an amplitude threshold. A second order zero-phase Butterworth band-pass filter with stop band corner frequencies at 0.3 MHz and 2.3 MHz, and pass band corner frequencies at 0.9 MHz and 1.7 MHz was used to filter the ultrasound breast data. To make a fair comparison, the same outlier removal procedures (median filtering and reciprocal pair check) were also applied to the amplitude threshold TOF picks. Fig. 8a shows the absolute values of TOF differences between manual picks and amplitude threshold picks, and Fig. 8b shows those of TOF difference between manual picks and our improved AIC picks. The statistics ( Table 2 ) shows that for these 1160 in vivo ultrasound breast waveforms, over 85% of the TOFs picked by our improved AIC picker are within three sample points (0.48 ?s) from the manual picks. The mean value and standard deviation between our improved TOF picker and manual picking are 0.4 ?s and 0.29 ?s, respectively. Among picks by the amplitude threshold picker, only 48% of them are within the three sample points from the manual picks, and the mean value and standard deviation from the manual picks are respectively 1.02 ?s and 0.9 ?s, which are much higher than those of our improved TOF picking method. Our study with other clinical ultrasound breast data shows that the performances of our improved wavelet–AIC TOF picker and amplitude threshold-based TOF picker are comparable for data with high SNRs, but for data with high noise level (or low SNRs), the accuracy of the amplitude threshold picker drops abruptly. Moreover, for noisy ultrasound breast data, the failure rate of the amplitude threshold TOF picker is much higher than for that of the improved AIC TOF picker. Fig. 9 shows two waveforms of different SNRs along with TOF picks by the above three methods. We can clearly see that for the waveform in Fig. 9a , which has a high SNR, the three TOF picks are consistent, although our improved AIC pick is closer to the manual pick. However, for a noisy waveform in Fig. 9b , the amplitude threshold picker picked the wrong TOF, while our improved AIC TOF pick is still comparable to the manual pick. The TOF picks in Fig. 9 are shown in Table 3 . An example of overlays of the TOF picks by our improved AIC TOF picker on the corresponding in vivo ultrasonic breast waveforms is depicted in Fig. 10 (the solid dot on each waveform segment indicates our TOF pick).  3. Sensitivity analysis and tomography results 3.1. Sensitivity analysis TOF sound–speed tomography uses the TOF picks of ultrasound breast data for reconstruction. The tomogram quality depends directly on the quality and accuracy of TOF picks. To test how the tomography images are affected by noise (errors) in TOFs, a simple sensitivity analysis has been done using a numerical model with the same source–receiver geometry as CURE. The true numerical model is illustrated in Fig. 11a , in which the background sound–speed is 1.5 mm/?s and the anomaly (white circle at the lower right quadrant) has a sound–speed of 1.545 mm/?s. The TOF for each source–receiver pair is calculated by solving the Eikonal equation on a very dense regular grid (0.1 mm × 0.1 mm). The calculated noise-free TOFs are inverted, and the tomogram at 5th iteration is presented in Fig. 11b . Random noise with a zero mean and standard deviation of 0.54 ?s (~3.4 sample intervals for CURE) is added to the above TOFs to simulate noisy data. Fig. 11d is the inverted tomogram at 5th iteration with the noisy TOFs. Even with visual comparison, the tomogram using noise-free TOFs ( Fig. 11b ) is clearly superior to the one in Fig. 11d . To quantitatively compare with true model ( Fig. 11a ), the residual sound–speed tomograms for Fig. 11b and d are presented in Fig. 11c and e , respectively. Except for the edge smoothing effect (which is generic to the tomography algorithm), the high sound–speed anomaly in Fig. 11c is accurately resolved (the absolute sound–speed difference between Fig. 11b and a is 0.001 mm/?s), and the background artifacts are negligible. In Fig. 11e , the reconstruction using noisy data results in a partially resolved anomaly (the absolute deviation from true model is about 0.025 mm/?s) and a very noisy background. These quantitative comparisons further prove that the noise (errors) in data have nonnegligible effects on the accuracy of tomography reconstructions. 3.2. Tomography results of in vitro and in vivo ultrasound data We compare tomograms obtained using our improved AIC TOF picks with that generated using amplitude threshold TOF picks for in vitro and in vivo ultrasound datasets. A cross-section image from an X-ray CT scan of a breast phantom is shown in Fig. 12a . The ultrasound sound–speed tomograms obtained using our improved AIC TOF picks and amplitude threshold TOF picks are shown in Fig. 12b and c , respectively. It can be seen that the tomogram in Fig. 12b contains significant fewer artifacts than the tomogram in Fig. 12c . Moreover, the four inclusions and surrounding subcutaneous fat are better reconstructed in Fig. 12b than those in Fig. 12c . In contrast to in vivo ultrasound breast data, the phantom breast data has relatively low structural noise due to relatively simple internal structures. In Fig. 13a and b , we performed a similar comparison for in vivo ultrasound breast data acquired with the CURE device. The in vivo breast data used to obtain Fig. 13a has a relative low SNR (~18 dB). The sound–speed tomogram produced using our improved TOF picks (the left panel in Fig. 13a ) appears to have fewer straight-line artifacts compared to the one obtained using amplitude threshold TOF picks (the right panel in Fig. 13a ). For in vivo ultrasound breast data with relative high SNR (~25 dB), the difference between the corresponding sound–speed tomograms shown in Fig. 13b is trivial, although the reconstruction with our improved TOF picks (the left panel in Fig. 13b ) still appears to be superior to the one produced using amplitude threshold TOF picks (the right panel in Fig. 13b ) in terms of the mass detection and reconstruction noise. These comparisons again demonstrate that our improved AIC TOF picker is much less sensitive to varying SNRs of ultrasound data than the amplitude threshold TOF picker.  3.1. Sensitivity analysis TOF sound–speed tomography uses the TOF picks of ultrasound breast data for reconstruction. The tomogram quality depends directly on the quality and accuracy of TOF picks. To test how the tomography images are affected by noise (errors) in TOFs, a simple sensitivity analysis has been done using a numerical model with the same source–receiver geometry as CURE. The true numerical model is illustrated in Fig. 11a , in which the background sound–speed is 1.5 mm/?s and the anomaly (white circle at the lower right quadrant) has a sound–speed of 1.545 mm/?s. The TOF for each source–receiver pair is calculated by solving the Eikonal equation on a very dense regular grid (0.1 mm × 0.1 mm). The calculated noise-free TOFs are inverted, and the tomogram at 5th iteration is presented in Fig. 11b . Random noise with a zero mean and standard deviation of 0.54 ?s (~3.4 sample intervals for CURE) is added to the above TOFs to simulate noisy data. Fig. 11d is the inverted tomogram at 5th iteration with the noisy TOFs. Even with visual comparison, the tomogram using noise-free TOFs ( Fig. 11b ) is clearly superior to the one in Fig. 11d . To quantitatively compare with true model ( Fig. 11a ), the residual sound–speed tomograms for Fig. 11b and d are presented in Fig. 11c and e , respectively. Except for the edge smoothing effect (which is generic to the tomography algorithm), the high sound–speed anomaly in Fig. 11c is accurately resolved (the absolute sound–speed difference between Fig. 11b and a is 0.001 mm/?s), and the background artifacts are negligible. In Fig. 11e , the reconstruction using noisy data results in a partially resolved anomaly (the absolute deviation from true model is about 0.025 mm/?s) and a very noisy background. These quantitative comparisons further prove that the noise (errors) in data have nonnegligible effects on the accuracy of tomography reconstructions.  3.2. Tomography results of in vitro and in vivo ultrasound data We compare tomograms obtained using our improved AIC TOF picks with that generated using amplitude threshold TOF picks for in vitro and in vivo ultrasound datasets. A cross-section image from an X-ray CT scan of a breast phantom is shown in Fig. 12a . The ultrasound sound–speed tomograms obtained using our improved AIC TOF picks and amplitude threshold TOF picks are shown in Fig. 12b and c , respectively. It can be seen that the tomogram in Fig. 12b contains significant fewer artifacts than the tomogram in Fig. 12c . Moreover, the four inclusions and surrounding subcutaneous fat are better reconstructed in Fig. 12b than those in Fig. 12c . In contrast to in vivo ultrasound breast data, the phantom breast data has relatively low structural noise due to relatively simple internal structures. In Fig. 13a and b , we performed a similar comparison for in vivo ultrasound breast data acquired with the CURE device. The in vivo breast data used to obtain Fig. 13a has a relative low SNR (~18 dB). The sound–speed tomogram produced using our improved TOF picks (the left panel in Fig. 13a ) appears to have fewer straight-line artifacts compared to the one obtained using amplitude threshold TOF picks (the right panel in Fig. 13a ). For in vivo ultrasound breast data with relative high SNR (~25 dB), the difference between the corresponding sound–speed tomograms shown in Fig. 13b is trivial, although the reconstruction with our improved TOF picks (the left panel in Fig. 13b ) still appears to be superior to the one produced using amplitude threshold TOF picks (the right panel in Fig. 13b ) in terms of the mass detection and reconstruction noise. These comparisons again demonstrate that our improved AIC TOF picker is much less sensitive to varying SNRs of ultrasound data than the amplitude threshold TOF picker.  4. Discussion Using TOFs picked by the AIC picker, our in vitro and in vivo reconstructions are based on a 2-D bent-ray approach, which has been well calibrated against breast phantoms and does two things very well. Producing reliable cross-sectional images of sound–speed and attenuation at a resolution of 2–4 mm (see [ 5 ] for a complete analysis of phantom data). Reproducing accurate estimates of quantitative image values (e.g. sound–speed in km/sec), again verified by phantom studies. It has been our experience that the diagnostic content of the images is as important as the image quality. Our rendering of breast architecture is achieved through our higher resolution reflection images ( Fig. 14 ) while the sound–speed and attenuation images provide diagnostic information that can be overlaid on the anatomical images ( Fig. 14 ). Given the diagnostic value of these data it is important that we are able to pick TOFs accurately and reliably. Again, to emphasize the point, image resolution and detailed breast architecture, though important for our reflection imaging, is not of paramount importance to the sound–speed and attenuation imaging. The method we have outlined in this paper is aimed at determining reliable quantitative values, necessary for adding diagnostic information (e.g. in Fig. 14 , high ss (white) = consistent with cancer). The picking routine allows us to generate such values reliably and the images produced are accurate enough given their lower spatial resolution. Furthermore, such images are needed as starting models for any wave-based approach.  4. Discussion Using TOFs picked by the AIC picker, our in vitro and in vivo reconstructions are based on a 2-D bent-ray approach, which has been well calibrated against breast phantoms and does two things very well. Producing reliable cross-sectional images of sound–speed and attenuation at a resolution of 2–4 mm (see [ 5 ] for a complete analysis of phantom data). Reproducing accurate estimates of quantitative image values (e.g. sound–speed in km/sec), again verified by phantom studies. It has been our experience that the diagnostic content of the images is as important as the image quality. Our rendering of breast architecture is achieved through our higher resolution reflection images ( Fig. 14 ) while the sound–speed and attenuation images provide diagnostic information that can be overlaid on the anatomical images ( Fig. 14 ). Given the diagnostic value of these data it is important that we are able to pick TOFs accurately and reliably. Again, to emphasize the point, image resolution and detailed breast architecture, though important for our reflection imaging, is not of paramount importance to the sound–speed and attenuation imaging. The method we have outlined in this paper is aimed at determining reliable quantitative values, necessary for adding diagnostic information (e.g. in Fig. 14 , high ss (white) = consistent with cancer). The picking routine allows us to generate such values reliably and the images produced are accurate enough given their lower spatial resolution. Furthermore, such images are needed as starting models for any wave-based approach.  5. Conclusions We have developed an improved automatic TOF picking method based on the Akaike information criterion and have successfully applied it to in vivo ultrasound breast data collected using a ring transducer array. To improve the accuracy of the TOF picking, our improved picking method incorporates all the information near the TOF point using a model inference method to determine the TOF of ultrasound signals. Our improved method also uses a median filter to remove TOF outliers. It can pick correct TOFs in noisy ultrasound data (with white noise of average absolute amplitudes of up to 80% of the maximum absolute amplitude of the signal) while the amplitude threshold based TOF picking method generally fails. It can determine TOFs of ultrasound breast data similar to those picked manually by an expert. A great advantage of our automatic TOF picker is that it is operator independent, and is much less time-consuming than the manual picking. This makes it possible to adopt our improved TOF picker into a clinical ultrasound tomography device. We have demonstrated that ultrasound sound–speed tomography using TOFs picked using our improved automatic TOF picker significantly improves the reconstruction accuracy and reduces image artifacts. 