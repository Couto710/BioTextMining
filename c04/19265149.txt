Synergy between individual tumor necrosis factor-dependent functions determines granuloma performance for controlling Mycobacterium tuberculosis infection 1 Mycobacterium tuberculosis is one of the world's most deadly human pathogens; an integrated understanding of how it successfully survives in its host is crucial to developing new treatment strategies. One notable characteristic of infection with M. tuberculosis is the formation of granulomas, aggregates of immune cells whose structure and function may reflect success or failure of the host to contain infection. One central regulator of host responses to infection, including granuloma formation, is the pleiotropic cytokine tumor necrosis factor-? (TNF). Experimental work has characterized roles for TNF in macrophage activation; regulation of apoptosis; chemokine and cytokine production; and regulation of cellular recruitment via trans-endothelial migration. Separating the effects of these functions is presently difficult or impossible in vivo . To this end, we applied a computational model to understand specific roles of TNF in control of tuberculosis in a single granuloma. In the model, cells are represented as discrete entities on a spatial grid responding to environmental stimuli by following programmed rules determined from published experimental studies. Simulated granulomas emerge as a result of these rules. After confirming the importance of TNF in this model, we assessed the effects of individual TNF functions. The model predicts that multiple TNF activities contribute to control of infection within the granuloma, with macrophage activation as a key effector mechanism for controlling bacterial growth. Results suggest that bacterial numbers are a strong contributing factor to granuloma structure with TNF. Finally, TNF-dependent apoptosis may reduce inflammation at the cost of impairing mycobacterial clearance.  Introduction Tuberculosis (TB) kills more people per year than any other single infectious disease. Infection by its causative agent, Mycobacterium tuberculosis (Mtb), results in active disease in only a minority of cases (?10%); the majority of infections are controlled and clinically silent, although the host often remains infected (reviewed in 1). The classic feature of pulmonary Mtb infection arises as a result of the immune response where aggregates of immune cells and bacteria, called granulomas, form in the lungs. In humans and non-human primates with latent pulmonary infection, granulomas form as well-circumscribed masses in the lung parenchyma comprised of resting, infected and activated macrophages with a characteristic cuff of T cells on the periphery (e.g. 2, 3) and a caseous necrotic center ( 4 ). Macrophages within a granuloma have dual roles in Mtb infection: they are the primary mechanism for Mtb containment and the preferred location for bacterial growth. During infection, there are often multiple and different types of granulomas within the lung; each could have a different outcome depending on local environment. At the level of a single granuloma, macrophages may fail to control infection, leading to necrotic granulomas harboring large numbers of bacteria within macrophages ( 3 ). However, the relationship between bacterial control in a single granuloma and the outcome of infection at the level of the entire host is not well established ( 3 ). Type-1 adaptive immunity is required to control infection at the host level ( 5 ). Activated T cells migrate to the site of infection and act as immune effectors. We distinguish three primary T cell types based on their effector function (c.f. 6). Pro-inflammatory T cells (CD4+ or CD8+) provide macrophage-activating cytokines (e.g. IFN-?) while cytotoxic T cells (predominantly CD8+) provide cytolytic functions to control infection (reviewed in 1). A third T cell class, regulatory T cells (Treg; reviewed in 7), are present in mouse ( 8 ) and human ( 9 ) Mtb infections, and may prevent efficient Mtb clearance by immune responses ( 10 , 11 ), or may modulate local responses to control pathology. Treg are CD4+Foxp3+ cells that comprise approximately 5-10% of all CD4+ T cells ( 12 , 13 ). They suppress the action of pro-inflammatory T cells ( 14 ) through poorly understood mechanisms that may occur by cell-contact, secretion of immunosuppressive cytokines ( 15 ), or both. The pro-inflammatory cytokine tumor necrosis factor-? (TNF) is a central, multi-faceted contributor to the immune response in Mtb infection produced by activated macrophages and pro-inflammatory T cells ( 16 - 20 ). The role of TNF is of clinical interest due to the association of anti-inflammatory TNF-blocking drugs with reactivation of latent TB in humans ( 21 , 22 ). TNF is also necessary for Mtb containment in mouse models ( 16 ). TNF gene-disrupted or neutralized mice have disorganized granulomas in Mtb infections ( 17 ), underscoring the link between granuloma structure and effective containment of infection. TNF has multiple immunological functions during infection with Mtb ( Figure 1A ). TNF has a direct role in immune cell recruitment via up-regulation of endothelial adhesion molecules ( 23 ), facilitating trans-endothelial migration of immune cells to the site of infection. TNF regulates production of chemokines by macrophages ( 24 , 25 ); chemokines can further induce trans-endothelial migration (reviewed in 26) and coordinate recruitment (reviewed in 27) of immune cells within the tissues. TNF activates macrophages in conjunction with the cytokine IFN-? ( 28 - 30 ); such activated macrophages can kill intracellular mycobacteria. TNF can also induce necrotic or apoptotic cell death in macrophages ( 31 ) that is promoted by Mtb infection ( 32 ). Figure 1A summarizes these effects. The effects of TNF in Mtb granuloma formation are likely related to the chemokine network induced during infection. We have identified a simplified model of chemokines based on three classes that affect recruitment of macrophages and T cells to the granuloma via binding of appropriate chemokine receptors on the cell surface ( Figure 1B ). The ?-chemoattractant class (CXCL9,10, and 11; formerly Mig, IP-10 and I-TAC, respectively) binds chemokine receptor CXCR3 on pro-inflammatory CD4+ and CD8+ T cells ( 33 ), but not regulatory T cells ( 34 ). CCL2 (formerly MCP-1) binds CCR2 on macrophages ( 35 ) and proportions of pro-inflammatory T cell populations ( 36 ). CCL5 (formerly RANTES) binds CCR5 on macrophages and T cells, and is involved in migration of regulatory T cells to the site of other infections ( 37 ), although this has not been demonstrated for Mtb. Each of the four roles of TNF (cellular migration, induction of chemokine/TNF secretion, macrophage activation and apoptosis) may contribute separately to establishing and maintaining control of Mtb infection at the level of a single granuloma. Currently, it is impossible to study these separate TNF functions using in vitro or in vivo models. Here we use a specific type of computational model known as an agent-based model (ABM) to study the contributions of these immune effectors on granuloma formation (illustrated in Figure 2 ). The power of this approach lies in the emergence of behaviors that arise from interactions between agents that would otherwise be impossible to know a priori . We build on our previously described ABM ( 38 ), which predicted the emergence of a two dimensional spherical structures (granulomas) without any rules specifying such spatial behavior to occur. We now incorporate various functions of TNF, different T cell classes and a simple chemokine network. This type of model, which combines spatial and temporal behaviors, is particularly suited to the investigation of granulomas due to the representation of cells, cytokines and bacteria, allowing tractable analysis of each factor independently or in combination. Analysis of an ABM reveals the specific contributions of TNF functions, alone and in combination, to control of Mtb infection and granuloma structure at the level of a single granuloma.  Methods Supplememental methods , results and time-lapse movies are available at http://malthus.micro.med.umich.edu/lab/movies/Granuloma2009/ . Hybrid agent-based model The model presented here is an extension of a previous ABM that captured cellular interactions leading to granuloma formation during infection with Mtb ( 38 ). The model is considered hybrid since we incorporated both discrete entities (cells) and continuous entities (chemokines, TNF and Mtb) that interact simultaneously. ABMs are developed based on four considerations: an environment, agents that reside there, the rules that describe the agents and their interactions, and the timescales on which events are defined. The environment represents a 2 mm × 2 mm section of lung parenchyma as a 100 × 100 square 2-dimensional lattice with individual micro-compartments scaled to the approximate size of a single macrophage: 20 ?m in diameter ( 39 ). Discrete agents move on the lattice and respond to their environment based on rules reflecting known biological activities. Bacteria and effector molecules can reside anywhere on the lattice and undergo diffusion when appropriate. Caseation represents inflammation of, and damage to, the lung parenchyma from macrophage cell death. We note a change of terminology to “caseation” from “necrosis” in previous work ( 38 ), as strict necrosis within the granuloma is now believed to be caused by substantial neutrophil infiltration and death, while caseation is likely initiated by macrophage death (unpublished data, JLF). In the ABM, caseation is defined to occur when a threshold number of activated or infected macrophage deaths take place in a micro-compartment. A final environmental feature is designation of spaces as vascular sources. We include two types of discrete agents in the model: macrophages and T cells. As previously ( 20 , 38 ), macrophage agents are either resting (Mr, uninfected), infected (Mi; have taken up bacteria), chronically infected (Mci; are unable to clear their intracellular bacterial load), or activated (Ma; can effectively kill bacteria). In contrast to our previous study ( 38 ), where a single T cell class captured all cell behaviors, here we represent three distinct T cell subpopulations based on function: the T? class captures CD4+ and CD8+ pro-inflammatory T cells; Tc represent cytotoxic T cells; and Treg represent regulatory T cells. In this representation, all T cells in a particular class have identical function; this is simpler than in vivo , but we capture enough detail in this representation for a qualitative representation of known T cell effects. In addition to the discrete entities, extracellular bacteria, diffusing effector molecules (CCL2, CCL5, CXCL9/10/11 and TNF) are agents (concentrations) that are tracked continuously over time. The chemokine model used here is a simplification that was chosen to include a ligand for each key chemokine receptor, while minimizing the distinct chemokine classes represented to save on computation. Cells respond to signals in the surrounding environment according to rules that represent known activities in vivo . During simulations, each agent responds depending on its state. Examples of rules include uptake of bacteria, macrophage activation by T cells, secretion of cytokines and chemokines, etc. For a full list of rules, see Supplement 1 . Computer Simulations At the beginning of a simulation, the grid has 105 randomly placed resident resting macrophages (Mr) that move randomly with no chemokine or cytokine present. Infection is initiated with one infected macrophage (Mi), containing a single bacterium, placed at the center. We chose this inoculum since we assume a single inhalation event. We also compared our results using a single bacteriurm to one using a larger inoculum (15 bacteria within an infected macrophage). In that scenario, clearance of infection occurred less often, with different kinetics at early timepoints, but after 20 days the two infection trajectories, and bacterial loads become similar from that point forward. Every 10 minutes of simulation time, positions and interactions between T cells and macrophages are updated, including recruitment of cells from vascular sources and secretion of TNF and chemokines. The landscape of molecular concentrations serves as the starting point for computing cytokine and chemokine diffusion for 10 minutes of simulation time. Cell states and interactions are then updated again, in the beginning of the next 10-minute timestep in an asynchronous fashion, and the algorithm continues in this way for 200 days (2,880,000 6s timesteps) of simulation time. Parameter estimates and uncertainty and sensitivity analyses It is difficult to estimate the rates and probabilities (parameters) of events occurring within the lung environment. We approximate parameter values in three ways: directly from available data, using uncertainty analysis, and model calibration with other data. Relative macrophage and T cell production were estimated from the literature ( 40 - 44 ). The macrophage CCL2 saturation point and detection threshold were estimated based on published data ( 45 ); T cell saturations are inferred from this. Tregs are more sensitive to CCL5 than T? or Tc cells ( 42 , 46 ). The resting macrophage lifespan ( M rls ) is based on ( 47 ); we assume a lifespan 10-fold shorter for activated macrophages ( M als ). The lifespan of a T cell is based on ( 48 ). The delay of T cell infiltration ( T delay ) is based on ( 49 ). Since absolute levels of chemokine production, saturation, etc were not known, we estimated the relative effects using calibration. Chemokine diffusion is based on ( 50 ). The initial number of macrophages ( M init ) represents approximately 1% coverage of the grid ( 38 ). The number of bacteria engulfed or killed by resting macrophages ( N rk ) was chosen to be low, but non-zero. The killing of ingested bacteria by activated macrophages ( N phag ) is related to the maximum number of intracellular Mtb that can exist in an infected macrophage before it is designated as chronically infected. N tact is a guess based on physical interactions of several T cells around a single macrophage. Other parameter value estimates are discussed in supplemental material All other parameters not discussed above that are listed in Tables I and III were estimated using uncertainty analysis, with various parameters calibrated to ensure distinct outcomes between control and TNF-deletion cases. Parameters in Table II , including production, sensitivity and saturation thresholds, and effects on recruitment for all other chemokines, were defined to preserve a relative relationship with the CCL5 parameters (dependent parameters). Thus, when Table I parameters (independent parameters) vary, Table II parameters also vary since they are proportional. Since not all parameters can be estimated from available data, it is necessary to use uncertainty and sensitivity methods to explore possible model outcomes using different parameter values. We have developed extensive methods for performing this analysis on ABMs and applied them here [see ( 51 ); for more details see Supplement 2 ]. Simulations using uncertainty analyses yielded a wide range of different granuloma structures and bacterial numbers within the granulomas ( Supplementary Figure 1 ). Data from humans and non-human primates with tuberculosis strongly supports the existence of a diverse array of granuloma types even within a single host ( 4 , 52 ). Simulated deletion and depletion of TNF activities To examine the effect of individual TNF activities on granuloma formation and maintenance, we performed virtual deletions and depletions of relevant parameters using a baseline parameter set that leads to control of infection ( Tables I - III ). Loss of activity was brought about by setting relevant probabilities to zero and/or raising relevant thresholds to an unattainable level. Virtual deletion refers to loss of the activity from the beginning of the simulation at the onset of infection. Virtual depletion refers to the loss of the activity after the establishment of a stable granuloma, 100 days post-infection. The timing of the depletion was determined by examining the results of sensitivity analysis and the baseline control scenario. Parameter sensitivities in the model stabilize by day 50 (c.f. Results), suggesting that 100 days post-infection represents a reasonable time for an established, stable granuloma. Significant differences between outcome variables were determined with a mean difference test (Welch's approximate t test) for 15 repeated simulations of each single deletion or depletion, and for 10 repeated simulations in deletion or depletion of two or more TNF activities simultaneously (for details, see Supplement 2 ). Simulations with bacterial levels fixed after 100 days post-infection To control for the effects of bacterial growth on granuloma structure, we fixed total bacterial levels (Be + Bi). Specifically, we simulated a baseline granuloma for 100 days and then fixed the total bacterial numbers to a constant level (2.75 +/- 0.51 log10 Mtb) for the next 100 simulation days. This allowed exploration of the effects of TNF depletions without the confounding effects of bacterial growth. To attain a fixed Mtb population, all bacterial growth and death was prevented, with the effects of bacteria on host macrophages allowed to otherwise proceed normally. Upon exit of intracellular Mtb from macrophages due to cell lysis or death, the bacteria were forced to deposit on the single micro-compartment where the macrophage resided after day 100 (unlike other simulations, where bacteria were distributed in the entire (Moore) neighborhood of a macrophage). This step prevents a biologically unrealistic scenario that could occur where the bacteria are “shuffled” to the outside of the granuloma. Note that intracellular and extracellular Mtb quantities still changed in the simulations, but the total bacterial number was conserved.  Hybrid agent-based model The model presented here is an extension of a previous ABM that captured cellular interactions leading to granuloma formation during infection with Mtb ( 38 ). The model is considered hybrid since we incorporated both discrete entities (cells) and continuous entities (chemokines, TNF and Mtb) that interact simultaneously. ABMs are developed based on four considerations: an environment, agents that reside there, the rules that describe the agents and their interactions, and the timescales on which events are defined. The environment represents a 2 mm × 2 mm section of lung parenchyma as a 100 × 100 square 2-dimensional lattice with individual micro-compartments scaled to the approximate size of a single macrophage: 20 ?m in diameter ( 39 ). Discrete agents move on the lattice and respond to their environment based on rules reflecting known biological activities. Bacteria and effector molecules can reside anywhere on the lattice and undergo diffusion when appropriate. Caseation represents inflammation of, and damage to, the lung parenchyma from macrophage cell death. We note a change of terminology to “caseation” from “necrosis” in previous work ( 38 ), as strict necrosis within the granuloma is now believed to be caused by substantial neutrophil infiltration and death, while caseation is likely initiated by macrophage death (unpublished data, JLF). In the ABM, caseation is defined to occur when a threshold number of activated or infected macrophage deaths take place in a micro-compartment. A final environmental feature is designation of spaces as vascular sources. We include two types of discrete agents in the model: macrophages and T cells. As previously ( 20 , 38 ), macrophage agents are either resting (Mr, uninfected), infected (Mi; have taken up bacteria), chronically infected (Mci; are unable to clear their intracellular bacterial load), or activated (Ma; can effectively kill bacteria). In contrast to our previous study ( 38 ), where a single T cell class captured all cell behaviors, here we represent three distinct T cell subpopulations based on function: the T? class captures CD4+ and CD8+ pro-inflammatory T cells; Tc represent cytotoxic T cells; and Treg represent regulatory T cells. In this representation, all T cells in a particular class have identical function; this is simpler than in vivo , but we capture enough detail in this representation for a qualitative representation of known T cell effects. In addition to the discrete entities, extracellular bacteria, diffusing effector molecules (CCL2, CCL5, CXCL9/10/11 and TNF) are agents (concentrations) that are tracked continuously over time. The chemokine model used here is a simplification that was chosen to include a ligand for each key chemokine receptor, while minimizing the distinct chemokine classes represented to save on computation. Cells respond to signals in the surrounding environment according to rules that represent known activities in vivo . During simulations, each agent responds depending on its state. Examples of rules include uptake of bacteria, macrophage activation by T cells, secretion of cytokines and chemokines, etc. For a full list of rules, see Supplement 1 .  Computer Simulations At the beginning of a simulation, the grid has 105 randomly placed resident resting macrophages (Mr) that move randomly with no chemokine or cytokine present. Infection is initiated with one infected macrophage (Mi), containing a single bacterium, placed at the center. We chose this inoculum since we assume a single inhalation event. We also compared our results using a single bacteriurm to one using a larger inoculum (15 bacteria within an infected macrophage). In that scenario, clearance of infection occurred less often, with different kinetics at early timepoints, but after 20 days the two infection trajectories, and bacterial loads become similar from that point forward. Every 10 minutes of simulation time, positions and interactions between T cells and macrophages are updated, including recruitment of cells from vascular sources and secretion of TNF and chemokines. The landscape of molecular concentrations serves as the starting point for computing cytokine and chemokine diffusion for 10 minutes of simulation time. Cell states and interactions are then updated again, in the beginning of the next 10-minute timestep in an asynchronous fashion, and the algorithm continues in this way for 200 days (2,880,000 6s timesteps) of simulation time.  Parameter estimates and uncertainty and sensitivity analyses It is difficult to estimate the rates and probabilities (parameters) of events occurring within the lung environment. We approximate parameter values in three ways: directly from available data, using uncertainty analysis, and model calibration with other data. Relative macrophage and T cell production were estimated from the literature ( 40 - 44 ). The macrophage CCL2 saturation point and detection threshold were estimated based on published data ( 45 ); T cell saturations are inferred from this. Tregs are more sensitive to CCL5 than T? or Tc cells ( 42 , 46 ). The resting macrophage lifespan ( M rls ) is based on ( 47 ); we assume a lifespan 10-fold shorter for activated macrophages ( M als ). The lifespan of a T cell is based on ( 48 ). The delay of T cell infiltration ( T delay ) is based on ( 49 ). Since absolute levels of chemokine production, saturation, etc were not known, we estimated the relative effects using calibration. Chemokine diffusion is based on ( 50 ). The initial number of macrophages ( M init ) represents approximately 1% coverage of the grid ( 38 ). The number of bacteria engulfed or killed by resting macrophages ( N rk ) was chosen to be low, but non-zero. The killing of ingested bacteria by activated macrophages ( N phag ) is related to the maximum number of intracellular Mtb that can exist in an infected macrophage before it is designated as chronically infected. N tact is a guess based on physical interactions of several T cells around a single macrophage. Other parameter value estimates are discussed in supplemental material All other parameters not discussed above that are listed in Tables I and III were estimated using uncertainty analysis, with various parameters calibrated to ensure distinct outcomes between control and TNF-deletion cases. Parameters in Table II , including production, sensitivity and saturation thresholds, and effects on recruitment for all other chemokines, were defined to preserve a relative relationship with the CCL5 parameters (dependent parameters). Thus, when Table I parameters (independent parameters) vary, Table II parameters also vary since they are proportional. Since not all parameters can be estimated from available data, it is necessary to use uncertainty and sensitivity methods to explore possible model outcomes using different parameter values. We have developed extensive methods for performing this analysis on ABMs and applied them here [see ( 51 ); for more details see Supplement 2 ]. Simulations using uncertainty analyses yielded a wide range of different granuloma structures and bacterial numbers within the granulomas ( Supplementary Figure 1 ). Data from humans and non-human primates with tuberculosis strongly supports the existence of a diverse array of granuloma types even within a single host ( 4 , 52 ).  Simulated deletion and depletion of TNF activities To examine the effect of individual TNF activities on granuloma formation and maintenance, we performed virtual deletions and depletions of relevant parameters using a baseline parameter set that leads to control of infection ( Tables I - III ). Loss of activity was brought about by setting relevant probabilities to zero and/or raising relevant thresholds to an unattainable level. Virtual deletion refers to loss of the activity from the beginning of the simulation at the onset of infection. Virtual depletion refers to the loss of the activity after the establishment of a stable granuloma, 100 days post-infection. The timing of the depletion was determined by examining the results of sensitivity analysis and the baseline control scenario. Parameter sensitivities in the model stabilize by day 50 (c.f. Results), suggesting that 100 days post-infection represents a reasonable time for an established, stable granuloma. Significant differences between outcome variables were determined with a mean difference test (Welch's approximate t test) for 15 repeated simulations of each single deletion or depletion, and for 10 repeated simulations in deletion or depletion of two or more TNF activities simultaneously (for details, see Supplement 2 ).  Simulations with bacterial levels fixed after 100 days post-infection To control for the effects of bacterial growth on granuloma structure, we fixed total bacterial levels (Be + Bi). Specifically, we simulated a baseline granuloma for 100 days and then fixed the total bacterial numbers to a constant level (2.75 +/- 0.51 log10 Mtb) for the next 100 simulation days. This allowed exploration of the effects of TNF depletions without the confounding effects of bacterial growth. To attain a fixed Mtb population, all bacterial growth and death was prevented, with the effects of bacteria on host macrophages allowed to otherwise proceed normally. Upon exit of intracellular Mtb from macrophages due to cell lysis or death, the bacteria were forced to deposit on the single micro-compartment where the macrophage resided after day 100 (unlike other simulations, where bacteria were distributed in the entire (Moore) neighborhood of a macrophage). This step prevents a biologically unrealistic scenario that could occur where the bacteria are “shuffled” to the outside of the granuloma. Note that intracellular and extracellular Mtb quantities still changed in the simulations, but the total bacterial number was conserved.  Results Agent based model for dissection of granuloma structure and function Computational models of the immune response to a pathogen can be deterministic (based on ordinary differential equations representing rates of change) or stochastic (based on probabilities of discrete agents and the rules governing their behavior). For the current investigation examining the contribution of various functions of TNF to granuloma structure and bacterial control in M. tuberculosis infection, we chose to use an ABM that is a hybrid model. This approach is appropriate because both spatial and temporal events must be considered when investigating the tuberculous granuloma. This ABM predicts the dynamics of Mtb infection at the level of a single granuloma. To first identify variables that determine initial containment or maintenance of an established infection at the scale of a single granuloma, we established a reference parameter set ( Tables I - III ) using uncertainty and sensitivity analyses as outlined in Methods and Supplement 2 . The baseline simulations lead to stable bacterial numbers contained within the granuloma (?103 total bacteria) up to 200 days post-infection ( Figure 3A , white bars). Repeated simulations show that the granuloma is organized with relatively tightly packed cells, predominantly uninfected macrophages (green agents in Figure 3B ), with T cell localization at the periphery of the granuloma (pink, purple, and light blue agents in Figure 3B ). The model is robust: for 15 repeated runs that established stable bacterial levels, all showed controlled infection with variable outcomes of granuloma structure ( Supplement 3 Figure S2A presents repeat simulations of the baseline scenario illustrating extent of variability). Simulated infection with all parameters set to the control scenario but lacking TNF (virtual TNF deletion) results in a granuloma that is irregular in shape, increased in size, and with wide-spread caseation ( Figure 3C ). Bacterial numbers are significantly higher than in the baseline scenario ( Figure 3A , gray bars: ?104 compared to 103; p < 0.01). Numbers of all macrophage and T cell populations in the model are significantly elevated in comparison to the baseline scenario within the first 20 days after infection (not shown). Therefore, loss of TNF appears to impair early control of infection, resulting in more extensive immune cell infiltration; this corresponds to data from murine models of Mtb infection ( 24 ). Factors that substantially contribute to control of infection within the granuloma To identify which parameters significantly contributed to control of Mtb infection within the granuloma, we performed a global uncertainty and sensitivity analysis, varying parameters in Tables I and II . Using the outcomes of this, we performed a sensitivity analysis to statistically determine which factors control bacterial numbers within the granuloma ( Fig 4A ). Approximately 2/3 of the simulations led to clearance of the infection. Some combinations of parameter values promote elimination of bacteria prior to granuloma formation due to apoptosis-induced killing and innate clearance by Mr (data not shown). The parameters that emerged as especially important were bacterial growth rates, T cell movement, and certain TNF-related effects. We then assessed the effects of these identified parameters on variables such as T cell functions, granuloma size, macrophage numbers and level of caseation in the model ( Table IV ). The analysis indicated that growth rates of intracellular and extracellular Mtb ( ? Bi and ? Be, respectively) are positively correlated with increased bacterial numbers in the granuloma 4 ( Figure 4A ). This result suggests that the growth rate of mycobacteria is a virulence factor, consistent with the published data that more virulent clinical strains of Mtb grow more quickly in macrophages ( 53 ). A faster intracellular growth rate leads to increased secretion of TNF and chemokines early in infection (due to increased antigenic stimulation), and to increased T cell activity by 200 days post-infection ( Table IV ). However, the heightened immune response is apparently incapable of controlling the infection in the face of the increased bacterial growth rate. This is recapitulated in animal models, where increased bacterial numbers results in increased inflammation and more T cell activation, but not necessarily better control of infection ( 54 ). Not surprisingly, the probability ( T move) of a T cell moving to a location occupied by another cell (either a T cell or a macrophage) is significantly negatively correlated with bacterial levels ( Fig 4A ). A micro-compartment can hold either two T cells or a T cell and a macrophage, but not two T cells and a macrophage or more than one macrophage. At 200 days, an increase in the rate of T move negatively impacts every measure in our model. In other words, a more tightly packed granuloma is more effective in controlling bacterial numbers, since this increases cell-cell interactions leading to activation of infected macrophages by T cells. As expected from the human and animal model data and our previous studies ( 17 , 20 ), TNF is crucial to the outcome of infection at the level of the granuloma ( Fig 3 ). In this analysis, the overall rate of TNF production ( s TNF ) was strongly negatively correlated with bacterial numbers ( Fig 4A ), confirming the necessity for TNF in controlling infection. Increased TNF production from the beginning of infection resulted in clearance of infection in more than half of the simulations. The rate of TNF secretion strongly and negatively influences most variables in the model – particularly in the long term (see Table IV ) - suggesting that the rate of TNF secretion from macrophages and T? cells ( s TNF ) has a global regulatory role in the system, with a major impact on immune cell and bacterial populations. Contribution of individual TNF-dependent mechanisms to infection outcome The original analysis confirmed a major role for TNF in control of the infection within the granuloma. In this model and in vivo , TNF has numerous functions, including inducing secretion of TNF and chemokines, activation of macrophages to a bactericidal state (in concert with IFN-?), recruitment of cells, and apoptosis of macrophages. To assess the correlation of individual TNF-related functions with control of bacterial infection, we performed a focused sensitivity analysis, varying only the 7 TNF parameters, with all other parameters at the values shown in Tables II - III . This analysis ( Figure 4B ) reveals positive correlations between extracellular Mtb numbers and four TNF-related parameters: ? TNFact (threshold for TNF-induced activation by macrophages); ? TNFapopt (threshold for TNF-induced apoptosis by macrophages); ? TNF (rate of TNF degradation); and r TNF (effect of TNF on cell recruitment via trans-endothelial migration). Not surprisingly, the rate of TNF secretion from macrophages and T? cells ( s TNF ) is still the most significantly correlated mechanism ( Figure 4B ). These results suggest that multiple TNF-dependent mechanisms contribute to the observed effect of TNF on bacterial control. The role of individual TNF-dependent mechanisms in control of infection To identify the contribution of each TNF-dependent mechanism individually to the outcome of infection at the granuloma level, we simulated deletion and depletion of each mechanism (both single and in combination). Virtual deletion and depletion of TNF-related macrophage activation shows significantly higher levels of extracellular bacteria and caseation, with lower numbers of activated macrophage and unchanged granuloma size ( Table V ; c.f. Supplement 3 Figure S2 for all simulated granulomas). The granuloma structures resemble an intermediate between the tightly packed form of the baseline scenario and the irregular core observed with complete TNF deletion or depletion (see Figure 3 ). Caseation is most likely increased because bacterial numbers increase, leading to more macrophage cell death (which contributes to caseation). Deletion and depletion of TNF-induced secretion activity ( Table VI ) suggests different roles for this activity before and after T cell infiltration begins. Loss of secretion activity (that is, TNF inducing TNF and chemokine production from macrophages) leads to higher levels of caseation and extracellular bacteria during a simulated deletion. No significant effects on these variables are observed during depletion, which has elevated intracellular bacteria and TNF/chemokines (compare Table VI E and F ). In contrast, during both deletion and depletion ( Table VI C and D ), loss of TNF recruitment activity leads to a reduction of immune cells indicating that this function of TNF is not infection stage specific. When comparing infection initiated with one bacterium (above) with that of 15 bacteria as the inoculum, there are differences in the TNF analysis. While examining the role of each TNF activity in the higher inoculum scenario, we found that the effects of depleting TNF-induced secretion is not significant in the 15 bacteria case, as it was in the single bacteria scenario. This implies that aspects of TNF activities may be sensitive to the initial bacterial inoculum. We are exploring this dose-response topic further in a manuscript in preparation. Is there a synergy or trade-off between TNF activities? To determine the effects of interactions between specific TNF activities on granuloma structure, we performed virtual deletions and depletions of pairs and triplets of individual activities. In this section we present results for TNF-dependent secretion, recruitment and activation, deferring exploration of apoptosis activity to the section below. Performing virtual double deletion/depletion of TNF-dependent recruitment and either secretion or activation activity results in the same outcome as either single depletion for secretion and activation (compare Figure 5A-B to Tables V and VI ). This suggests that TNF-dependent recruitment is not playing a major role in the control of infection at the level of the granuloma. In contrast, virtual double deletion/depletion with TNF-dependent activation and secretion yields results similar to deletion/depletion of all TNF activities where the granuloma is larger in size, bacterial levels are increased and there is increased caseation (compare Figure 5C with Tables V and VI ). A triple deletion/depletion of these three activities also results in poorly formed granulomas with high bacterial loads and caseation ( Figure 5D,H ). Together these results suggest that both activation and secretion activities of TNF contribute important and distinct roles to granuloma function, formation and/or maintenance, and that TNF-dependent recruitment is not a significant factor. Supplement 3 Figure S3 shows all simulated granulomas at day 200 for all combinations of deletions and depletions. Granuloma Structure For many of the results obtained thus far it is difficult to distinguish the role of bacterial numbers versus TNF activity in driving the structure of the granuloma. To address this, we perform a simulation that is impossible to do in vivo , namely, to allow the granuloma to form and then to fix the total number of bacteria present (see Methods for more details). This allows us to isolate the effects of TNF without the contribution of changing bacterial numbers. Figure 6 shows results of fixing the bacterial levels and performing virtual depletions performed at day 100 for: all TNF, secretion, recruitment and activation activities, respectively. Depletion of TNF recruitment in these simulations did have an impact on the number of T cells at the site, and the granulomas were on average smaller (but not significantly so). However, the granuloma structures were not affected. In all other cases, depletion of the single TNF activities did not affect the shape or size of the granuloma once bacterial numbers were fixed. This suggests that bacterial load is the primary factor responsible determining granuloma structure and shape. Role of TNF-induced Apoptosis An unanticipated finding was that deletion and depletion of TNF-induced apoptosis results in effective clearance of bacteria (“Apoptosis” in Table V ). At the time after all bacteria were cleared, there is disrupted granuloma structure with a robust increase in cell infiltration and TNF/chemokine production ( Table V ). Separate depletion of TNF-induced apoptosis activity from infected and uninfected macrophages shows that this phenomenon is primarily driven by uninfected macrophages, which constitute the largest macrophage sub-population (data not shown). These data suggest that TNF-induced apoptosis of uninfected macrophages within the granuloma prevents excessive inflammation, but this leads to persistent Mtb infection. To directly assess the contribution to granuloma structure, we fixed bacterial numbers at 100 days as described above and eliminated TNF-dependent apoptosis. We again observed the hyper-inflammatory state described above ( Figure 7A ). This supports a major role for uninfected macrophages driving granuloma structure. One possible explanation is that in the absence of apoptotic cell death of macrophages, induction of TNF at the site of infection continues to induce TNF in surrounding macrophages, forming a positive feedback loop- a process normally limited by TNF-induced apoptosis in this model. To test this possibility, we performed virtual deletion or depletion of both apoptosis and TNF-induced secretion of both TNF and chemokines ( Figure 7B ). Without secretion of TNF and chemokines, loss of apoptosis did not result in enhanced inflammation and resolution of infection, clearly demonstrating that the robust inflammatory response in the single deletion and depletion of apoptosis was dependent on TNF-mediated induction of TNF and chemokines from uninfected macrophages. This may be a feedback loop where bacteria released by dying macrophages induce secretion of TNF, and higher subsequent levels of TNF and chemokines. Apoptosis of macrophages likely prevents this TNF-induced cytokine/chemokine response by both reducing the bacteria released from macrophages and eliminating excess macrophages from the granuloma; these macrophages are the source of the cytokines and chemokines that influence the inflammatory response. Combining a loss of TNF-mediated apoptosis with loss of TNF-induced macrophage activation ( Figure 7C ) results in substantially worse inflammation, but no clearance of bacteria, because macrophage activation is essential for Mtb killing. Deleting or depleting both apoptosis and TNF-mediated cell recruitment ( Figure 7D ) is not different than the individually simulated apoptosis deletion and depletion, indicating that the observed excess inflammation is not due to changes in total recruitment of cells to the lungs.  Results Agent based model for dissection of granuloma structure and function Computational models of the immune response to a pathogen can be deterministic (based on ordinary differential equations representing rates of change) or stochastic (based on probabilities of discrete agents and the rules governing their behavior). For the current investigation examining the contribution of various functions of TNF to granuloma structure and bacterial control in M. tuberculosis infection, we chose to use an ABM that is a hybrid model. This approach is appropriate because both spatial and temporal events must be considered when investigating the tuberculous granuloma. This ABM predicts the dynamics of Mtb infection at the level of a single granuloma. To first identify variables that determine initial containment or maintenance of an established infection at the scale of a single granuloma, we established a reference parameter set ( Tables I - III ) using uncertainty and sensitivity analyses as outlined in Methods and Supplement 2 . The baseline simulations lead to stable bacterial numbers contained within the granuloma (?103 total bacteria) up to 200 days post-infection ( Figure 3A , white bars). Repeated simulations show that the granuloma is organized with relatively tightly packed cells, predominantly uninfected macrophages (green agents in Figure 3B ), with T cell localization at the periphery of the granuloma (pink, purple, and light blue agents in Figure 3B ). The model is robust: for 15 repeated runs that established stable bacterial levels, all showed controlled infection with variable outcomes of granuloma structure ( Supplement 3 Figure S2A presents repeat simulations of the baseline scenario illustrating extent of variability). Simulated infection with all parameters set to the control scenario but lacking TNF (virtual TNF deletion) results in a granuloma that is irregular in shape, increased in size, and with wide-spread caseation ( Figure 3C ). Bacterial numbers are significantly higher than in the baseline scenario ( Figure 3A , gray bars: ?104 compared to 103; p < 0.01). Numbers of all macrophage and T cell populations in the model are significantly elevated in comparison to the baseline scenario within the first 20 days after infection (not shown). Therefore, loss of TNF appears to impair early control of infection, resulting in more extensive immune cell infiltration; this corresponds to data from murine models of Mtb infection ( 24 ). Factors that substantially contribute to control of infection within the granuloma To identify which parameters significantly contributed to control of Mtb infection within the granuloma, we performed a global uncertainty and sensitivity analysis, varying parameters in Tables I and II . Using the outcomes of this, we performed a sensitivity analysis to statistically determine which factors control bacterial numbers within the granuloma ( Fig 4A ). Approximately 2/3 of the simulations led to clearance of the infection. Some combinations of parameter values promote elimination of bacteria prior to granuloma formation due to apoptosis-induced killing and innate clearance by Mr (data not shown). The parameters that emerged as especially important were bacterial growth rates, T cell movement, and certain TNF-related effects. We then assessed the effects of these identified parameters on variables such as T cell functions, granuloma size, macrophage numbers and level of caseation in the model ( Table IV ). The analysis indicated that growth rates of intracellular and extracellular Mtb ( ? Bi and ? Be, respectively) are positively correlated with increased bacterial numbers in the granuloma 4 ( Figure 4A ). This result suggests that the growth rate of mycobacteria is a virulence factor, consistent with the published data that more virulent clinical strains of Mtb grow more quickly in macrophages ( 53 ). A faster intracellular growth rate leads to increased secretion of TNF and chemokines early in infection (due to increased antigenic stimulation), and to increased T cell activity by 200 days post-infection ( Table IV ). However, the heightened immune response is apparently incapable of controlling the infection in the face of the increased bacterial growth rate. This is recapitulated in animal models, where increased bacterial numbers results in increased inflammation and more T cell activation, but not necessarily better control of infection ( 54 ). Not surprisingly, the probability ( T move) of a T cell moving to a location occupied by another cell (either a T cell or a macrophage) is significantly negatively correlated with bacterial levels ( Fig 4A ). A micro-compartment can hold either two T cells or a T cell and a macrophage, but not two T cells and a macrophage or more than one macrophage. At 200 days, an increase in the rate of T move negatively impacts every measure in our model. In other words, a more tightly packed granuloma is more effective in controlling bacterial numbers, since this increases cell-cell interactions leading to activation of infected macrophages by T cells. As expected from the human and animal model data and our previous studies ( 17 , 20 ), TNF is crucial to the outcome of infection at the level of the granuloma ( Fig 3 ). In this analysis, the overall rate of TNF production ( s TNF ) was strongly negatively correlated with bacterial numbers ( Fig 4A ), confirming the necessity for TNF in controlling infection. Increased TNF production from the beginning of infection resulted in clearance of infection in more than half of the simulations. The rate of TNF secretion strongly and negatively influences most variables in the model – particularly in the long term (see Table IV ) - suggesting that the rate of TNF secretion from macrophages and T? cells ( s TNF ) has a global regulatory role in the system, with a major impact on immune cell and bacterial populations. Contribution of individual TNF-dependent mechanisms to infection outcome The original analysis confirmed a major role for TNF in control of the infection within the granuloma. In this model and in vivo , TNF has numerous functions, including inducing secretion of TNF and chemokines, activation of macrophages to a bactericidal state (in concert with IFN-?), recruitment of cells, and apoptosis of macrophages. To assess the correlation of individual TNF-related functions with control of bacterial infection, we performed a focused sensitivity analysis, varying only the 7 TNF parameters, with all other parameters at the values shown in Tables II - III . This analysis ( Figure 4B ) reveals positive correlations between extracellular Mtb numbers and four TNF-related parameters: ? TNFact (threshold for TNF-induced activation by macrophages); ? TNFapopt (threshold for TNF-induced apoptosis by macrophages); ? TNF (rate of TNF degradation); and r TNF (effect of TNF on cell recruitment via trans-endothelial migration). Not surprisingly, the rate of TNF secretion from macrophages and T? cells ( s TNF ) is still the most significantly correlated mechanism ( Figure 4B ). These results suggest that multiple TNF-dependent mechanisms contribute to the observed effect of TNF on bacterial control. The role of individual TNF-dependent mechanisms in control of infection To identify the contribution of each TNF-dependent mechanism individually to the outcome of infection at the granuloma level, we simulated deletion and depletion of each mechanism (both single and in combination). Virtual deletion and depletion of TNF-related macrophage activation shows significantly higher levels of extracellular bacteria and caseation, with lower numbers of activated macrophage and unchanged granuloma size ( Table V ; c.f. Supplement 3 Figure S2 for all simulated granulomas). The granuloma structures resemble an intermediate between the tightly packed form of the baseline scenario and the irregular core observed with complete TNF deletion or depletion (see Figure 3 ). Caseation is most likely increased because bacterial numbers increase, leading to more macrophage cell death (which contributes to caseation). Deletion and depletion of TNF-induced secretion activity ( Table VI ) suggests different roles for this activity before and after T cell infiltration begins. Loss of secretion activity (that is, TNF inducing TNF and chemokine production from macrophages) leads to higher levels of caseation and extracellular bacteria during a simulated deletion. No significant effects on these variables are observed during depletion, which has elevated intracellular bacteria and TNF/chemokines (compare Table VI E and F ). In contrast, during both deletion and depletion ( Table VI C and D ), loss of TNF recruitment activity leads to a reduction of immune cells indicating that this function of TNF is not infection stage specific. When comparing infection initiated with one bacterium (above) with that of 15 bacteria as the inoculum, there are differences in the TNF analysis. While examining the role of each TNF activity in the higher inoculum scenario, we found that the effects of depleting TNF-induced secretion is not significant in the 15 bacteria case, as it was in the single bacteria scenario. This implies that aspects of TNF activities may be sensitive to the initial bacterial inoculum. We are exploring this dose-response topic further in a manuscript in preparation. Is there a synergy or trade-off between TNF activities? To determine the effects of interactions between specific TNF activities on granuloma structure, we performed virtual deletions and depletions of pairs and triplets of individual activities. In this section we present results for TNF-dependent secretion, recruitment and activation, deferring exploration of apoptosis activity to the section below. Performing virtual double deletion/depletion of TNF-dependent recruitment and either secretion or activation activity results in the same outcome as either single depletion for secretion and activation (compare Figure 5A-B to Tables V and VI ). This suggests that TNF-dependent recruitment is not playing a major role in the control of infection at the level of the granuloma. In contrast, virtual double deletion/depletion with TNF-dependent activation and secretion yields results similar to deletion/depletion of all TNF activities where the granuloma is larger in size, bacterial levels are increased and there is increased caseation (compare Figure 5C with Tables V and VI ). A triple deletion/depletion of these three activities also results in poorly formed granulomas with high bacterial loads and caseation ( Figure 5D,H ). Together these results suggest that both activation and secretion activities of TNF contribute important and distinct roles to granuloma function, formation and/or maintenance, and that TNF-dependent recruitment is not a significant factor. Supplement 3 Figure S3 shows all simulated granulomas at day 200 for all combinations of deletions and depletions. Granuloma Structure For many of the results obtained thus far it is difficult to distinguish the role of bacterial numbers versus TNF activity in driving the structure of the granuloma. To address this, we perform a simulation that is impossible to do in vivo , namely, to allow the granuloma to form and then to fix the total number of bacteria present (see Methods for more details). This allows us to isolate the effects of TNF without the contribution of changing bacterial numbers. Figure 6 shows results of fixing the bacterial levels and performing virtual depletions performed at day 100 for: all TNF, secretion, recruitment and activation activities, respectively. Depletion of TNF recruitment in these simulations did have an impact on the number of T cells at the site, and the granulomas were on average smaller (but not significantly so). However, the granuloma structures were not affected. In all other cases, depletion of the single TNF activities did not affect the shape or size of the granuloma once bacterial numbers were fixed. This suggests that bacterial load is the primary factor responsible determining granuloma structure and shape. Role of TNF-induced Apoptosis An unanticipated finding was that deletion and depletion of TNF-induced apoptosis results in effective clearance of bacteria (“Apoptosis” in Table V ). At the time after all bacteria were cleared, there is disrupted granuloma structure with a robust increase in cell infiltration and TNF/chemokine production ( Table V ). Separate depletion of TNF-induced apoptosis activity from infected and uninfected macrophages shows that this phenomenon is primarily driven by uninfected macrophages, which constitute the largest macrophage sub-population (data not shown). These data suggest that TNF-induced apoptosis of uninfected macrophages within the granuloma prevents excessive inflammation, but this leads to persistent Mtb infection. To directly assess the contribution to granuloma structure, we fixed bacterial numbers at 100 days as described above and eliminated TNF-dependent apoptosis. We again observed the hyper-inflammatory state described above ( Figure 7A ). This supports a major role for uninfected macrophages driving granuloma structure. One possible explanation is that in the absence of apoptotic cell death of macrophages, induction of TNF at the site of infection continues to induce TNF in surrounding macrophages, forming a positive feedback loop- a process normally limited by TNF-induced apoptosis in this model. To test this possibility, we performed virtual deletion or depletion of both apoptosis and TNF-induced secretion of both TNF and chemokines ( Figure 7B ). Without secretion of TNF and chemokines, loss of apoptosis did not result in enhanced inflammation and resolution of infection, clearly demonstrating that the robust inflammatory response in the single deletion and depletion of apoptosis was dependent on TNF-mediated induction of TNF and chemokines from uninfected macrophages. This may be a feedback loop where bacteria released by dying macrophages induce secretion of TNF, and higher subsequent levels of TNF and chemokines. Apoptosis of macrophages likely prevents this TNF-induced cytokine/chemokine response by both reducing the bacteria released from macrophages and eliminating excess macrophages from the granuloma; these macrophages are the source of the cytokines and chemokines that influence the inflammatory response. Combining a loss of TNF-mediated apoptosis with loss of TNF-induced macrophage activation ( Figure 7C ) results in substantially worse inflammation, but no clearance of bacteria, because macrophage activation is essential for Mtb killing. Deleting or depleting both apoptosis and TNF-mediated cell recruitment ( Figure 7D ) is not different than the individually simulated apoptosis deletion and depletion, indicating that the observed excess inflammation is not due to changes in total recruitment of cells to the lungs.  Agent based model for dissection of granuloma structure and function Computational models of the immune response to a pathogen can be deterministic (based on ordinary differential equations representing rates of change) or stochastic (based on probabilities of discrete agents and the rules governing their behavior). For the current investigation examining the contribution of various functions of TNF to granuloma structure and bacterial control in M. tuberculosis infection, we chose to use an ABM that is a hybrid model. This approach is appropriate because both spatial and temporal events must be considered when investigating the tuberculous granuloma. This ABM predicts the dynamics of Mtb infection at the level of a single granuloma. To first identify variables that determine initial containment or maintenance of an established infection at the scale of a single granuloma, we established a reference parameter set ( Tables I - III ) using uncertainty and sensitivity analyses as outlined in Methods and Supplement 2 . The baseline simulations lead to stable bacterial numbers contained within the granuloma (?103 total bacteria) up to 200 days post-infection ( Figure 3A , white bars). Repeated simulations show that the granuloma is organized with relatively tightly packed cells, predominantly uninfected macrophages (green agents in Figure 3B ), with T cell localization at the periphery of the granuloma (pink, purple, and light blue agents in Figure 3B ). The model is robust: for 15 repeated runs that established stable bacterial levels, all showed controlled infection with variable outcomes of granuloma structure ( Supplement 3 Figure S2A presents repeat simulations of the baseline scenario illustrating extent of variability). Simulated infection with all parameters set to the control scenario but lacking TNF (virtual TNF deletion) results in a granuloma that is irregular in shape, increased in size, and with wide-spread caseation ( Figure 3C ). Bacterial numbers are significantly higher than in the baseline scenario ( Figure 3A , gray bars: ?104 compared to 103; p < 0.01). Numbers of all macrophage and T cell populations in the model are significantly elevated in comparison to the baseline scenario within the first 20 days after infection (not shown). Therefore, loss of TNF appears to impair early control of infection, resulting in more extensive immune cell infiltration; this corresponds to data from murine models of Mtb infection ( 24 ).  Agent based model for dissection of granuloma structure and function Computational models of the immune response to a pathogen can be deterministic (based on ordinary differential equations representing rates of change) or stochastic (based on probabilities of discrete agents and the rules governing their behavior). For the current investigation examining the contribution of various functions of TNF to granuloma structure and bacterial control in M. tuberculosis infection, we chose to use an ABM that is a hybrid model. This approach is appropriate because both spatial and temporal events must be considered when investigating the tuberculous granuloma. This ABM predicts the dynamics of Mtb infection at the level of a single granuloma. To first identify variables that determine initial containment or maintenance of an established infection at the scale of a single granuloma, we established a reference parameter set ( Tables I - III ) using uncertainty and sensitivity analyses as outlined in Methods and Supplement 2 . The baseline simulations lead to stable bacterial numbers contained within the granuloma (?103 total bacteria) up to 200 days post-infection ( Figure 3A , white bars). Repeated simulations show that the granuloma is organized with relatively tightly packed cells, predominantly uninfected macrophages (green agents in Figure 3B ), with T cell localization at the periphery of the granuloma (pink, purple, and light blue agents in Figure 3B ). The model is robust: for 15 repeated runs that established stable bacterial levels, all showed controlled infection with variable outcomes of granuloma structure ( Supplement 3 Figure S2A presents repeat simulations of the baseline scenario illustrating extent of variability). Simulated infection with all parameters set to the control scenario but lacking TNF (virtual TNF deletion) results in a granuloma that is irregular in shape, increased in size, and with wide-spread caseation ( Figure 3C ). Bacterial numbers are significantly higher than in the baseline scenario ( Figure 3A , gray bars: ?104 compared to 103; p < 0.01). Numbers of all macrophage and T cell populations in the model are significantly elevated in comparison to the baseline scenario within the first 20 days after infection (not shown). Therefore, loss of TNF appears to impair early control of infection, resulting in more extensive immune cell infiltration; this corresponds to data from murine models of Mtb infection ( 24 ).  Factors that substantially contribute to control of infection within the granuloma To identify which parameters significantly contributed to control of Mtb infection within the granuloma, we performed a global uncertainty and sensitivity analysis, varying parameters in Tables I and II . Using the outcomes of this, we performed a sensitivity analysis to statistically determine which factors control bacterial numbers within the granuloma ( Fig 4A ). Approximately 2/3 of the simulations led to clearance of the infection. Some combinations of parameter values promote elimination of bacteria prior to granuloma formation due to apoptosis-induced killing and innate clearance by Mr (data not shown). The parameters that emerged as especially important were bacterial growth rates, T cell movement, and certain TNF-related effects. We then assessed the effects of these identified parameters on variables such as T cell functions, granuloma size, macrophage numbers and level of caseation in the model ( Table IV ). The analysis indicated that growth rates of intracellular and extracellular Mtb ( ? Bi and ? Be, respectively) are positively correlated with increased bacterial numbers in the granuloma 4 ( Figure 4A ). This result suggests that the growth rate of mycobacteria is a virulence factor, consistent with the published data that more virulent clinical strains of Mtb grow more quickly in macrophages ( 53 ). A faster intracellular growth rate leads to increased secretion of TNF and chemokines early in infection (due to increased antigenic stimulation), and to increased T cell activity by 200 days post-infection ( Table IV ). However, the heightened immune response is apparently incapable of controlling the infection in the face of the increased bacterial growth rate. This is recapitulated in animal models, where increased bacterial numbers results in increased inflammation and more T cell activation, but not necessarily better control of infection ( 54 ). Not surprisingly, the probability ( T move) of a T cell moving to a location occupied by another cell (either a T cell or a macrophage) is significantly negatively correlated with bacterial levels ( Fig 4A ). A micro-compartment can hold either two T cells or a T cell and a macrophage, but not two T cells and a macrophage or more than one macrophage. At 200 days, an increase in the rate of T move negatively impacts every measure in our model. In other words, a more tightly packed granuloma is more effective in controlling bacterial numbers, since this increases cell-cell interactions leading to activation of infected macrophages by T cells. As expected from the human and animal model data and our previous studies ( 17 , 20 ), TNF is crucial to the outcome of infection at the level of the granuloma ( Fig 3 ). In this analysis, the overall rate of TNF production ( s TNF ) was strongly negatively correlated with bacterial numbers ( Fig 4A ), confirming the necessity for TNF in controlling infection. Increased TNF production from the beginning of infection resulted in clearance of infection in more than half of the simulations. The rate of TNF secretion strongly and negatively influences most variables in the model – particularly in the long term (see Table IV ) - suggesting that the rate of TNF secretion from macrophages and T? cells ( s TNF ) has a global regulatory role in the system, with a major impact on immune cell and bacterial populations.  Factors that substantially contribute to control of infection within the granuloma To identify which parameters significantly contributed to control of Mtb infection within the granuloma, we performed a global uncertainty and sensitivity analysis, varying parameters in Tables I and II . Using the outcomes of this, we performed a sensitivity analysis to statistically determine which factors control bacterial numbers within the granuloma ( Fig 4A ). Approximately 2/3 of the simulations led to clearance of the infection. Some combinations of parameter values promote elimination of bacteria prior to granuloma formation due to apoptosis-induced killing and innate clearance by Mr (data not shown). The parameters that emerged as especially important were bacterial growth rates, T cell movement, and certain TNF-related effects. We then assessed the effects of these identified parameters on variables such as T cell functions, granuloma size, macrophage numbers and level of caseation in the model ( Table IV ). The analysis indicated that growth rates of intracellular and extracellular Mtb ( ? Bi and ? Be, respectively) are positively correlated with increased bacterial numbers in the granuloma 4 ( Figure 4A ). This result suggests that the growth rate of mycobacteria is a virulence factor, consistent with the published data that more virulent clinical strains of Mtb grow more quickly in macrophages ( 53 ). A faster intracellular growth rate leads to increased secretion of TNF and chemokines early in infection (due to increased antigenic stimulation), and to increased T cell activity by 200 days post-infection ( Table IV ). However, the heightened immune response is apparently incapable of controlling the infection in the face of the increased bacterial growth rate. This is recapitulated in animal models, where increased bacterial numbers results in increased inflammation and more T cell activation, but not necessarily better control of infection ( 54 ). Not surprisingly, the probability ( T move) of a T cell moving to a location occupied by another cell (either a T cell or a macrophage) is significantly negatively correlated with bacterial levels ( Fig 4A ). A micro-compartment can hold either two T cells or a T cell and a macrophage, but not two T cells and a macrophage or more than one macrophage. At 200 days, an increase in the rate of T move negatively impacts every measure in our model. In other words, a more tightly packed granuloma is more effective in controlling bacterial numbers, since this increases cell-cell interactions leading to activation of infected macrophages by T cells. As expected from the human and animal model data and our previous studies ( 17 , 20 ), TNF is crucial to the outcome of infection at the level of the granuloma ( Fig 3 ). In this analysis, the overall rate of TNF production ( s TNF ) was strongly negatively correlated with bacterial numbers ( Fig 4A ), confirming the necessity for TNF in controlling infection. Increased TNF production from the beginning of infection resulted in clearance of infection in more than half of the simulations. The rate of TNF secretion strongly and negatively influences most variables in the model – particularly in the long term (see Table IV ) - suggesting that the rate of TNF secretion from macrophages and T? cells ( s TNF ) has a global regulatory role in the system, with a major impact on immune cell and bacterial populations.  Contribution of individual TNF-dependent mechanisms to infection outcome The original analysis confirmed a major role for TNF in control of the infection within the granuloma. In this model and in vivo , TNF has numerous functions, including inducing secretion of TNF and chemokines, activation of macrophages to a bactericidal state (in concert with IFN-?), recruitment of cells, and apoptosis of macrophages. To assess the correlation of individual TNF-related functions with control of bacterial infection, we performed a focused sensitivity analysis, varying only the 7 TNF parameters, with all other parameters at the values shown in Tables II - III . This analysis ( Figure 4B ) reveals positive correlations between extracellular Mtb numbers and four TNF-related parameters: ? TNFact (threshold for TNF-induced activation by macrophages); ? TNFapopt (threshold for TNF-induced apoptosis by macrophages); ? TNF (rate of TNF degradation); and r TNF (effect of TNF on cell recruitment via trans-endothelial migration). Not surprisingly, the rate of TNF secretion from macrophages and T? cells ( s TNF ) is still the most significantly correlated mechanism ( Figure 4B ). These results suggest that multiple TNF-dependent mechanisms contribute to the observed effect of TNF on bacterial control.  Contribution of individual TNF-dependent mechanisms to infection outcome The original analysis confirmed a major role for TNF in control of the infection within the granuloma. In this model and in vivo , TNF has numerous functions, including inducing secretion of TNF and chemokines, activation of macrophages to a bactericidal state (in concert with IFN-?), recruitment of cells, and apoptosis of macrophages. To assess the correlation of individual TNF-related functions with control of bacterial infection, we performed a focused sensitivity analysis, varying only the 7 TNF parameters, with all other parameters at the values shown in Tables II - III . This analysis ( Figure 4B ) reveals positive correlations between extracellular Mtb numbers and four TNF-related parameters: ? TNFact (threshold for TNF-induced activation by macrophages); ? TNFapopt (threshold for TNF-induced apoptosis by macrophages); ? TNF (rate of TNF degradation); and r TNF (effect of TNF on cell recruitment via trans-endothelial migration). Not surprisingly, the rate of TNF secretion from macrophages and T? cells ( s TNF ) is still the most significantly correlated mechanism ( Figure 4B ). These results suggest that multiple TNF-dependent mechanisms contribute to the observed effect of TNF on bacterial control.  The role of individual TNF-dependent mechanisms in control of infection To identify the contribution of each TNF-dependent mechanism individually to the outcome of infection at the granuloma level, we simulated deletion and depletion of each mechanism (both single and in combination). Virtual deletion and depletion of TNF-related macrophage activation shows significantly higher levels of extracellular bacteria and caseation, with lower numbers of activated macrophage and unchanged granuloma size ( Table V ; c.f. Supplement 3 Figure S2 for all simulated granulomas). The granuloma structures resemble an intermediate between the tightly packed form of the baseline scenario and the irregular core observed with complete TNF deletion or depletion (see Figure 3 ). Caseation is most likely increased because bacterial numbers increase, leading to more macrophage cell death (which contributes to caseation). Deletion and depletion of TNF-induced secretion activity ( Table VI ) suggests different roles for this activity before and after T cell infiltration begins. Loss of secretion activity (that is, TNF inducing TNF and chemokine production from macrophages) leads to higher levels of caseation and extracellular bacteria during a simulated deletion. No significant effects on these variables are observed during depletion, which has elevated intracellular bacteria and TNF/chemokines (compare Table VI E and F ). In contrast, during both deletion and depletion ( Table VI C and D ), loss of TNF recruitment activity leads to a reduction of immune cells indicating that this function of TNF is not infection stage specific. When comparing infection initiated with one bacterium (above) with that of 15 bacteria as the inoculum, there are differences in the TNF analysis. While examining the role of each TNF activity in the higher inoculum scenario, we found that the effects of depleting TNF-induced secretion is not significant in the 15 bacteria case, as it was in the single bacteria scenario. This implies that aspects of TNF activities may be sensitive to the initial bacterial inoculum. We are exploring this dose-response topic further in a manuscript in preparation.  The role of individual TNF-dependent mechanisms in control of infection To identify the contribution of each TNF-dependent mechanism individually to the outcome of infection at the granuloma level, we simulated deletion and depletion of each mechanism (both single and in combination). Virtual deletion and depletion of TNF-related macrophage activation shows significantly higher levels of extracellular bacteria and caseation, with lower numbers of activated macrophage and unchanged granuloma size ( Table V ; c.f. Supplement 3 Figure S2 for all simulated granulomas). The granuloma structures resemble an intermediate between the tightly packed form of the baseline scenario and the irregular core observed with complete TNF deletion or depletion (see Figure 3 ). Caseation is most likely increased because bacterial numbers increase, leading to more macrophage cell death (which contributes to caseation). Deletion and depletion of TNF-induced secretion activity ( Table VI ) suggests different roles for this activity before and after T cell infiltration begins. Loss of secretion activity (that is, TNF inducing TNF and chemokine production from macrophages) leads to higher levels of caseation and extracellular bacteria during a simulated deletion. No significant effects on these variables are observed during depletion, which has elevated intracellular bacteria and TNF/chemokines (compare Table VI E and F ). In contrast, during both deletion and depletion ( Table VI C and D ), loss of TNF recruitment activity leads to a reduction of immune cells indicating that this function of TNF is not infection stage specific. When comparing infection initiated with one bacterium (above) with that of 15 bacteria as the inoculum, there are differences in the TNF analysis. While examining the role of each TNF activity in the higher inoculum scenario, we found that the effects of depleting TNF-induced secretion is not significant in the 15 bacteria case, as it was in the single bacteria scenario. This implies that aspects of TNF activities may be sensitive to the initial bacterial inoculum. We are exploring this dose-response topic further in a manuscript in preparation.  Is there a synergy or trade-off between TNF activities? To determine the effects of interactions between specific TNF activities on granuloma structure, we performed virtual deletions and depletions of pairs and triplets of individual activities. In this section we present results for TNF-dependent secretion, recruitment and activation, deferring exploration of apoptosis activity to the section below. Performing virtual double deletion/depletion of TNF-dependent recruitment and either secretion or activation activity results in the same outcome as either single depletion for secretion and activation (compare Figure 5A-B to Tables V and VI ). This suggests that TNF-dependent recruitment is not playing a major role in the control of infection at the level of the granuloma. In contrast, virtual double deletion/depletion with TNF-dependent activation and secretion yields results similar to deletion/depletion of all TNF activities where the granuloma is larger in size, bacterial levels are increased and there is increased caseation (compare Figure 5C with Tables V and VI ). A triple deletion/depletion of these three activities also results in poorly formed granulomas with high bacterial loads and caseation ( Figure 5D,H ). Together these results suggest that both activation and secretion activities of TNF contribute important and distinct roles to granuloma function, formation and/or maintenance, and that TNF-dependent recruitment is not a significant factor. Supplement 3 Figure S3 shows all simulated granulomas at day 200 for all combinations of deletions and depletions.  Is there a synergy or trade-off between TNF activities? To determine the effects of interactions between specific TNF activities on granuloma structure, we performed virtual deletions and depletions of pairs and triplets of individual activities. In this section we present results for TNF-dependent secretion, recruitment and activation, deferring exploration of apoptosis activity to the section below. Performing virtual double deletion/depletion of TNF-dependent recruitment and either secretion or activation activity results in the same outcome as either single depletion for secretion and activation (compare Figure 5A-B to Tables V and VI ). This suggests that TNF-dependent recruitment is not playing a major role in the control of infection at the level of the granuloma. In contrast, virtual double deletion/depletion with TNF-dependent activation and secretion yields results similar to deletion/depletion of all TNF activities where the granuloma is larger in size, bacterial levels are increased and there is increased caseation (compare Figure 5C with Tables V and VI ). A triple deletion/depletion of these three activities also results in poorly formed granulomas with high bacterial loads and caseation ( Figure 5D,H ). Together these results suggest that both activation and secretion activities of TNF contribute important and distinct roles to granuloma function, formation and/or maintenance, and that TNF-dependent recruitment is not a significant factor. Supplement 3 Figure S3 shows all simulated granulomas at day 200 for all combinations of deletions and depletions.  Granuloma Structure For many of the results obtained thus far it is difficult to distinguish the role of bacterial numbers versus TNF activity in driving the structure of the granuloma. To address this, we perform a simulation that is impossible to do in vivo , namely, to allow the granuloma to form and then to fix the total number of bacteria present (see Methods for more details). This allows us to isolate the effects of TNF without the contribution of changing bacterial numbers. Figure 6 shows results of fixing the bacterial levels and performing virtual depletions performed at day 100 for: all TNF, secretion, recruitment and activation activities, respectively. Depletion of TNF recruitment in these simulations did have an impact on the number of T cells at the site, and the granulomas were on average smaller (but not significantly so). However, the granuloma structures were not affected. In all other cases, depletion of the single TNF activities did not affect the shape or size of the granuloma once bacterial numbers were fixed. This suggests that bacterial load is the primary factor responsible determining granuloma structure and shape.  Granuloma Structure For many of the results obtained thus far it is difficult to distinguish the role of bacterial numbers versus TNF activity in driving the structure of the granuloma. To address this, we perform a simulation that is impossible to do in vivo , namely, to allow the granuloma to form and then to fix the total number of bacteria present (see Methods for more details). This allows us to isolate the effects of TNF without the contribution of changing bacterial numbers. Figure 6 shows results of fixing the bacterial levels and performing virtual depletions performed at day 100 for: all TNF, secretion, recruitment and activation activities, respectively. Depletion of TNF recruitment in these simulations did have an impact on the number of T cells at the site, and the granulomas were on average smaller (but not significantly so). However, the granuloma structures were not affected. In all other cases, depletion of the single TNF activities did not affect the shape or size of the granuloma once bacterial numbers were fixed. This suggests that bacterial load is the primary factor responsible determining granuloma structure and shape.  Role of TNF-induced Apoptosis An unanticipated finding was that deletion and depletion of TNF-induced apoptosis results in effective clearance of bacteria (“Apoptosis” in Table V ). At the time after all bacteria were cleared, there is disrupted granuloma structure with a robust increase in cell infiltration and TNF/chemokine production ( Table V ). Separate depletion of TNF-induced apoptosis activity from infected and uninfected macrophages shows that this phenomenon is primarily driven by uninfected macrophages, which constitute the largest macrophage sub-population (data not shown). These data suggest that TNF-induced apoptosis of uninfected macrophages within the granuloma prevents excessive inflammation, but this leads to persistent Mtb infection. To directly assess the contribution to granuloma structure, we fixed bacterial numbers at 100 days as described above and eliminated TNF-dependent apoptosis. We again observed the hyper-inflammatory state described above ( Figure 7A ). This supports a major role for uninfected macrophages driving granuloma structure. One possible explanation is that in the absence of apoptotic cell death of macrophages, induction of TNF at the site of infection continues to induce TNF in surrounding macrophages, forming a positive feedback loop- a process normally limited by TNF-induced apoptosis in this model. To test this possibility, we performed virtual deletion or depletion of both apoptosis and TNF-induced secretion of both TNF and chemokines ( Figure 7B ). Without secretion of TNF and chemokines, loss of apoptosis did not result in enhanced inflammation and resolution of infection, clearly demonstrating that the robust inflammatory response in the single deletion and depletion of apoptosis was dependent on TNF-mediated induction of TNF and chemokines from uninfected macrophages. This may be a feedback loop where bacteria released by dying macrophages induce secretion of TNF, and higher subsequent levels of TNF and chemokines. Apoptosis of macrophages likely prevents this TNF-induced cytokine/chemokine response by both reducing the bacteria released from macrophages and eliminating excess macrophages from the granuloma; these macrophages are the source of the cytokines and chemokines that influence the inflammatory response. Combining a loss of TNF-mediated apoptosis with loss of TNF-induced macrophage activation ( Figure 7C ) results in substantially worse inflammation, but no clearance of bacteria, because macrophage activation is essential for Mtb killing. Deleting or depleting both apoptosis and TNF-mediated cell recruitment ( Figure 7D ) is not different than the individually simulated apoptosis deletion and depletion, indicating that the observed excess inflammation is not due to changes in total recruitment of cells to the lungs.  Role of TNF-induced Apoptosis An unanticipated finding was that deletion and depletion of TNF-induced apoptosis results in effective clearance of bacteria (“Apoptosis” in Table V ). At the time after all bacteria were cleared, there is disrupted granuloma structure with a robust increase in cell infiltration and TNF/chemokine production ( Table V ). Separate depletion of TNF-induced apoptosis activity from infected and uninfected macrophages shows that this phenomenon is primarily driven by uninfected macrophages, which constitute the largest macrophage sub-population (data not shown). These data suggest that TNF-induced apoptosis of uninfected macrophages within the granuloma prevents excessive inflammation, but this leads to persistent Mtb infection. To directly assess the contribution to granuloma structure, we fixed bacterial numbers at 100 days as described above and eliminated TNF-dependent apoptosis. We again observed the hyper-inflammatory state described above ( Figure 7A ). This supports a major role for uninfected macrophages driving granuloma structure. One possible explanation is that in the absence of apoptotic cell death of macrophages, induction of TNF at the site of infection continues to induce TNF in surrounding macrophages, forming a positive feedback loop- a process normally limited by TNF-induced apoptosis in this model. To test this possibility, we performed virtual deletion or depletion of both apoptosis and TNF-induced secretion of both TNF and chemokines ( Figure 7B ). Without secretion of TNF and chemokines, loss of apoptosis did not result in enhanced inflammation and resolution of infection, clearly demonstrating that the robust inflammatory response in the single deletion and depletion of apoptosis was dependent on TNF-mediated induction of TNF and chemokines from uninfected macrophages. This may be a feedback loop where bacteria released by dying macrophages induce secretion of TNF, and higher subsequent levels of TNF and chemokines. Apoptosis of macrophages likely prevents this TNF-induced cytokine/chemokine response by both reducing the bacteria released from macrophages and eliminating excess macrophages from the granuloma; these macrophages are the source of the cytokines and chemokines that influence the inflammatory response. Combining a loss of TNF-mediated apoptosis with loss of TNF-induced macrophage activation ( Figure 7C ) results in substantially worse inflammation, but no clearance of bacteria, because macrophage activation is essential for Mtb killing. Deleting or depleting both apoptosis and TNF-mediated cell recruitment ( Figure 7D ) is not different than the individually simulated apoptosis deletion and depletion, indicating that the observed excess inflammation is not due to changes in total recruitment of cells to the lungs.  Discussion TNF is clearly a central factor in control of M. tuberculosis infection. It has been repeatedly demonstrated in murine models that granuloma function, formation and maintenance are dependent on TNF ( 24 ). However, TNF is a pleiotropic cytokine and the relative contributions of its primary activities to the functional and structural characteristics of the granuloma have not been elucidated. The complex nature of TNF in the immune response to M. tuberculosis likely accounts for the dramatic effects observed when neutralizing this cytokine in humans with latent M. tuberculosis infection ( 21 ) and in animal models ( 16 , 19 ).The agent based model of a tuberculous granuloma developed in this study is unique in its ability to address the roles of individual functions of TNF in granuloma formation and control of infection. The major findings from this study are: 1. Both TNF-induced macrophage activation and TNF-dependent secretion of chemokines and cytokines are crucial factors in control of infection within the granuloma; 2. TNF-induced apoptosis functions to reduce inflammation at the expense of impairing bacterial clearance; 3. Structural alterations in granuloma size and shape resulting from perturbation of TNF activity is directly driven by bacterial growth, and indirectly by TNF activities. Our agent-based model of granuloma formation reproduces major features of infection by representing interactions of individual cell agents and molecular effectors with a representation of a growing mycobacterial population. This work was based on a previous model ( 38 ) with major extensions that include representations of TNF, a simple chemokine network, and distinct T cell sub-populations, including effector and regulatory cells. A baseline parameter set demonstrates bacterial control and variable granuloma structures, both of which are disrupted by virtual deletion or depletion of TNF. This sophisticated model allows for a spatial and temporal representation of events occurring during granuloma formation and function allowing for exploration of this complex biological system in ways that are currently not tractable with experimental methods. A next logical step is to consider a three-dimensional spatial representation, and this may be important for making further predictions about elements within the system. On the other hand, a three-dimensional granuloma model ( 55 ) gave similar results to our previous two-dimensional model ( 38 ), suggesting that the two-dimensional approach is sufficient to study many aspects of granuloma formation. One further important simplification in our model is a reduction in the number of cell types to only those with well-characterized roles in Mtb granulomas. Multinucleate giant cells may modulate chemokine production ( 56 ) without taking up extracellular Mtb ( 57 ); dendritic cells are necessary for optimal antigenic stimulation of T cells ( 58 , 59 ); foamy cells are dendritic-like cells ( 60 ) that may be a nutrient source for Mtb ( 61 ); B cells form ectopic germinal centers in Mtb-infected mouse lungs, with some role in containment ( 62 ). Each of these cell types may have important quantitative or qualitative roles, but are not sufficiently characterized to include in this model. Future work can easily incorporate these into the model when mechanistic information becomes available. Our model provides the opportunity to study various combinations of effector functions controlled by TNF. Virtual deletion or depletion of each individual TNF-related function demonstrated that TNF-dependent macrophage activation was the primary factor involved in control of bacterial numbers, but that TNF-induced chemokine and TNF secretion also played a role in this process, probably by bringing macrophages and T cells close together in the granuloma, as well as producing more TNF in the granuloma. In contrast, loss of TNF-mediated recruitment, where TNF acts on the vasculature to bring more cells into the lungs, had little effect on bacterial numbers, but resulted in recruitment of fewer immune cells. This is consistent with reduced recruitment in TNF-blockaded M. bovis BCG infection in mice ( 63 ); lower virulence of BCG compared to Mtb may explain why complete loss of TNF activity did not cause a severe phenotype in that study. Virtual elimination of both TNF-dependent macrophage activation and cytokine/chemokine secretion resulted in large granulomas with extensive caseation and lack of bacterial control that was essentially identical to the scenario of total loss of TNF, and was worse than loss of either function independently. In contrast, eliminating TNF-mediated recruitment had no additional detrimental effects when coupled with the loss of TNF-dependent macrophage activation or secretion. Thus, both macrophage activation and cytokine/chemokine secretion induced by TNF are important and distinct functions in control of bacterial numbers in the granuloma. Based on data in the murine system, including our own data, it has been widely believed that TNF is the major factor that controls the actual formation, structure and maintenance of a granuloma ( 17 , 64 ). Humans treated with TNF-neutralizing drugs for inflammatory diseases have an increased incidence of reactivation tuberculosis. In an initial report ( 21 ), lung biopsies from a patient with disseminated tuberculosis due to TNF neutralization did not reveal granulomas, supporting the murine data. However, another human study ( 65 ) has indicated that granulomas are present in tuberculous lungs from TNF-neutralized patients, calling into question whether TNF is required for maintenance of granulomas. Indeed, data from our non-human primate model of tuberculosis also indicate that granulomas can form and be maintained even when TNF is neutralized (Lin, Flynn, manuscript submitted). The current virtual model provides an opportunity to test the functions of TNF that are related to granuloma function, formation and structure. The flexibility of this model, compared to in vivo systems, allows us to hold the bacterial numbers steady while varying other parameters. This provides an opportunity to distinguish between effects of granuloma structure that are due to bacterial numbers or to TNF-dependent factors. In fact, when bacterial numbers cannot increase as a result of TNF depletion, granuloma structure is essentially unaffected by loss of TNF-dependent factors. This suggests that bacterial numbers are a driving force in the aberrations in granuloma formation and maintenance due to loss of TNF. This does not negate a role for TNF in the formation and maintenance of granulomas, but instead suggests that bacterial numbers play a greater role in this than previously believed. One surprising finding was that deletion and depletion of TNF-induced apoptosis results in effective clearance of bacteria. Simulations predicted disrupted granuloma structure, increased cell infiltration and TNF/chemokine production in this case. Virtual depletion of TNF-induced apoptosis activity from infected or uninfected macrophages demonstrated that this phenomenon is primarily driven by uninfected macrophages. Comparing dual and single depletions, as well as the “fixed bacterial numbers” simulations, it became clear that the increased inflammation observed in the absence of apoptosis was due to TNF-induced secretion of chemokines and TNF from uninfected macrophages. This function of TNF enhances bacterial clearance, but can lead to excessive pathology. Thus a role for TNF-induced apoptosis seems to be control of pathology at the expense of bacterial clearance. This provides evidence that the outcome of infection in any one granuloma is a balance of different factors, including TNF-induced functions. This result may differ if certain anti-inflammatory cytokines such as IL-10 were included in the model, which could modulate the effects of TNF; this possibility has been proposed previously ( 66 ). The size of the initial bacterial inoculum may have some effects on progression and containment of Mtb infection, particularly in cases with immunological deficiencies (e.g. 67). We explored the effects of increasing the bacterial load in the first infected macrophage from one bacterium to 15. Cell and bacterial kinetics were different preceding T cell infiltration at 20 days post-infection, but became very similar after (not shown). The primary difference in dose as it relates to TNF activities is for TNF-induced secretion of chemokines and TNF. For the low inoculum, depleting this activity significantly affected aspects of the granuloma ( Table VI ), where for the higher inoculum, no significant effects for the depletion were observed (not shown). A very high inoculum, above the small range we tested here, would likely have dramatic effects on the outcome of infection, as demonstrated in our previous studies ( 6 , 20 ), although the effect may not manifest at the level of a single granuloma. We have a manuscript in preparation exploring the role of initial dose in a more detailed fashion. In this work we have used an advanced mathematical modeling approach to identify the relative contribution of different TNF-dependent activities in granuloma formation and function. Model results predicted mechanisms involved in control of both bacterial numbers within the granuloma as well as inflammation. These mechanisms can now serve as putative targets for vaccine and treatment strategies. The approach applied here contributes groundwork for the use of computational approaches in identifying biological pathways that can be targeted for modulation of tuberculosis.  Discussion TNF is clearly a central factor in control of M. tuberculosis infection. It has been repeatedly demonstrated in murine models that granuloma function, formation and maintenance are dependent on TNF ( 24 ). However, TNF is a pleiotropic cytokine and the relative contributions of its primary activities to the functional and structural characteristics of the granuloma have not been elucidated. The complex nature of TNF in the immune response to M. tuberculosis likely accounts for the dramatic effects observed when neutralizing this cytokine in humans with latent M. tuberculosis infection ( 21 ) and in animal models ( 16 , 19 ).The agent based model of a tuberculous granuloma developed in this study is unique in its ability to address the roles of individual functions of TNF in granuloma formation and control of infection. The major findings from this study are: 1. Both TNF-induced macrophage activation and TNF-dependent secretion of chemokines and cytokines are crucial factors in control of infection within the granuloma; 2. TNF-induced apoptosis functions to reduce inflammation at the expense of impairing bacterial clearance; 3. Structural alterations in granuloma size and shape resulting from perturbation of TNF activity is directly driven by bacterial growth, and indirectly by TNF activities. Our agent-based model of granuloma formation reproduces major features of infection by representing interactions of individual cell agents and molecular effectors with a representation of a growing mycobacterial population. This work was based on a previous model ( 38 ) with major extensions that include representations of TNF, a simple chemokine network, and distinct T cell sub-populations, including effector and regulatory cells. A baseline parameter set demonstrates bacterial control and variable granuloma structures, both of which are disrupted by virtual deletion or depletion of TNF. This sophisticated model allows for a spatial and temporal representation of events occurring during granuloma formation and function allowing for exploration of this complex biological system in ways that are currently not tractable with experimental methods. A next logical step is to consider a three-dimensional spatial representation, and this may be important for making further predictions about elements within the system. On the other hand, a three-dimensional granuloma model ( 55 ) gave similar results to our previous two-dimensional model ( 38 ), suggesting that the two-dimensional approach is sufficient to study many aspects of granuloma formation. One further important simplification in our model is a reduction in the number of cell types to only those with well-characterized roles in Mtb granulomas. Multinucleate giant cells may modulate chemokine production ( 56 ) without taking up extracellular Mtb ( 57 ); dendritic cells are necessary for optimal antigenic stimulation of T cells ( 58 , 59 ); foamy cells are dendritic-like cells ( 60 ) that may be a nutrient source for Mtb ( 61 ); B cells form ectopic germinal centers in Mtb-infected mouse lungs, with some role in containment ( 62 ). Each of these cell types may have important quantitative or qualitative roles, but are not sufficiently characterized to include in this model. Future work can easily incorporate these into the model when mechanistic information becomes available. Our model provides the opportunity to study various combinations of effector functions controlled by TNF. Virtual deletion or depletion of each individual TNF-related function demonstrated that TNF-dependent macrophage activation was the primary factor involved in control of bacterial numbers, but that TNF-induced chemokine and TNF secretion also played a role in this process, probably by bringing macrophages and T cells close together in the granuloma, as well as producing more TNF in the granuloma. In contrast, loss of TNF-mediated recruitment, where TNF acts on the vasculature to bring more cells into the lungs, had little effect on bacterial numbers, but resulted in recruitment of fewer immune cells. This is consistent with reduced recruitment in TNF-blockaded M. bovis BCG infection in mice ( 63 ); lower virulence of BCG compared to Mtb may explain why complete loss of TNF activity did not cause a severe phenotype in that study. Virtual elimination of both TNF-dependent macrophage activation and cytokine/chemokine secretion resulted in large granulomas with extensive caseation and lack of bacterial control that was essentially identical to the scenario of total loss of TNF, and was worse than loss of either function independently. In contrast, eliminating TNF-mediated recruitment had no additional detrimental effects when coupled with the loss of TNF-dependent macrophage activation or secretion. Thus, both macrophage activation and cytokine/chemokine secretion induced by TNF are important and distinct functions in control of bacterial numbers in the granuloma. Based on data in the murine system, including our own data, it has been widely believed that TNF is the major factor that controls the actual formation, structure and maintenance of a granuloma ( 17 , 64 ). Humans treated with TNF-neutralizing drugs for inflammatory diseases have an increased incidence of reactivation tuberculosis. In an initial report ( 21 ), lung biopsies from a patient with disseminated tuberculosis due to TNF neutralization did not reveal granulomas, supporting the murine data. However, another human study ( 65 ) has indicated that granulomas are present in tuberculous lungs from TNF-neutralized patients, calling into question whether TNF is required for maintenance of granulomas. Indeed, data from our non-human primate model of tuberculosis also indicate that granulomas can form and be maintained even when TNF is neutralized (Lin, Flynn, manuscript submitted). The current virtual model provides an opportunity to test the functions of TNF that are related to granuloma function, formation and structure. The flexibility of this model, compared to in vivo systems, allows us to hold the bacterial numbers steady while varying other parameters. This provides an opportunity to distinguish between effects of granuloma structure that are due to bacterial numbers or to TNF-dependent factors. In fact, when bacterial numbers cannot increase as a result of TNF depletion, granuloma structure is essentially unaffected by loss of TNF-dependent factors. This suggests that bacterial numbers are a driving force in the aberrations in granuloma formation and maintenance due to loss of TNF. This does not negate a role for TNF in the formation and maintenance of granulomas, but instead suggests that bacterial numbers play a greater role in this than previously believed. One surprising finding was that deletion and depletion of TNF-induced apoptosis results in effective clearance of bacteria. Simulations predicted disrupted granuloma structure, increased cell infiltration and TNF/chemokine production in this case. Virtual depletion of TNF-induced apoptosis activity from infected or uninfected macrophages demonstrated that this phenomenon is primarily driven by uninfected macrophages. Comparing dual and single depletions, as well as the “fixed bacterial numbers” simulations, it became clear that the increased inflammation observed in the absence of apoptosis was due to TNF-induced secretion of chemokines and TNF from uninfected macrophages. This function of TNF enhances bacterial clearance, but can lead to excessive pathology. Thus a role for TNF-induced apoptosis seems to be control of pathology at the expense of bacterial clearance. This provides evidence that the outcome of infection in any one granuloma is a balance of different factors, including TNF-induced functions. This result may differ if certain anti-inflammatory cytokines such as IL-10 were included in the model, which could modulate the effects of TNF; this possibility has been proposed previously ( 66 ). The size of the initial bacterial inoculum may have some effects on progression and containment of Mtb infection, particularly in cases with immunological deficiencies (e.g. 67). We explored the effects of increasing the bacterial load in the first infected macrophage from one bacterium to 15. Cell and bacterial kinetics were different preceding T cell infiltration at 20 days post-infection, but became very similar after (not shown). The primary difference in dose as it relates to TNF activities is for TNF-induced secretion of chemokines and TNF. For the low inoculum, depleting this activity significantly affected aspects of the granuloma ( Table VI ), where for the higher inoculum, no significant effects for the depletion were observed (not shown). A very high inoculum, above the small range we tested here, would likely have dramatic effects on the outcome of infection, as demonstrated in our previous studies ( 6 , 20 ), although the effect may not manifest at the level of a single granuloma. We have a manuscript in preparation exploring the role of initial dose in a more detailed fashion. In this work we have used an advanced mathematical modeling approach to identify the relative contribution of different TNF-dependent activities in granuloma formation and function. Model results predicted mechanisms involved in control of both bacterial numbers within the granuloma as well as inflammation. These mechanisms can now serve as putative targets for vaccine and treatment strategies. The approach applied here contributes groundwork for the use of computational approaches in identifying biological pathways that can be targeted for modulation of tuberculosis.  Supplementary Material Supplement 1 Supplement 2 Supplement 3  Supplementary Material Supplement 1 Supplement 2 Supplement 3 